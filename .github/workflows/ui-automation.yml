name: ui-automation

on:
  workflow_dispatch:
    inputs:
      do_publish:
        description: 'Run Python publish (Shopify + Pinterest) before UI automation'
        type: boolean
        default: false
      publer_edit_url:
        description: 'Publer edit URL to open (required for UI edit)'
        type: string
        default: ''
      shopify_public_url:
        description: 'Shopify public article URL to verify (optional)'
        type: string
        default: ''

jobs:
  publish:
    if: ${{ inputs.do_publish }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Publish 1 item (raw-genai)
        env:
          # Prefer strongest free text provider chain
          LLM_PROVIDER_ORDER: gemini,github_models,perplexity,openai
          DISABLE_OPENAI: 'true'
          VIRALOPS_PINTEREST_ALBUM_NAME: blogs
          # Secrets (set these in repo Settings → Actions → Secrets)
          GH_MODELS_API_KEY: ${{ secrets.GH_MODELS_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FALLBACK_GEMINI_API_KEY: ${{ secrets.FALLBACK_GEMINI_API_KEY }}
          SECOND_FALLBACK_GEMINI_API_KEY: ${{ secrets.SECOND_FALLBACK_GEMINI_API_KEY }}
          THIRD_FALLBACK_GEMINI_API_KEY: ${{ secrets.THIRD_FALLBACK_GEMINI_API_KEY }}
          PUBLER_API_KEY: ${{ secrets.PUBLER_API_KEY }}
          SHOPIFY_ADMIN_TOKEN: ${{ secrets.SHOPIFY_ADMIN_TOKEN }}
          SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
          SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
          SHOPIFY_PUBLIC_DOMAIN: ${{ secrets.SHOPIFY_PUBLIC_DOMAIN }}
        run: |
          python scripts/batch_auto_niche_topics.py --publish --no-publer-dedup --limit 1 --platforms shopify_blog,pinterest --shopify --raw-genai --no-hashtags
      - name: Upload kit + image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: viralops-kit
          path: |
            pinterest_manual_edit_last.txt
            artifacts/last_pinterest_pin.jpg
            artifacts/last_pinterest_pin.png
          if-no-files-found: warn

  ui:
    runs-on: ubuntu-latest
    needs: [publish]
    if: ${{ always() }}
    steps:
      - uses: actions/checkout@v4
      - name: Download kit artifacts (if any)
        uses: actions/download-artifact@v4
        with:
          name: viralops-kit
          path: .
        continue-on-error: true

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install UI automation deps
        working-directory: ui-automation
        run: |
          npm ci
          npx playwright install --with-deps

      - name: Run Playwright
        working-directory: ui-automation
        env:
          PUBLER_BASE_URL: https://app.publer.io
          PUBLER_EDIT_URL: ${{ inputs.publer_edit_url }}
          PUBLER_EMAIL: ${{ secrets.PUBLER_EMAIL }}
          PUBLER_PASSWORD: ${{ secrets.PUBLER_PASSWORD }}
          PINTEREST_KIT_PATH: ${{ github.workspace }}/pinterest_manual_edit_last.txt
          SHOPIFY_PUBLIC_URL: ${{ inputs.shopify_public_url }}
        run: |
          npm test

      - name: Upload Playwright report
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: ui-automation/playwright-report
          if-no-files-found: warn
