<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ViralOps Engine</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' },
            brand: { 50:'#eef2ff', 100:'#e0e7ff', 200:'#c7d2fe', 400:'#818cf8', 500:'#6366f1', 600:'#4f46e5', 700:'#4338ca' }
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .page { display: none; }
    .page.active { display: block; }
    .toast { animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards; }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } }
    @keyframes fadeOut { to { opacity: 0; } }
    .chip { transition: all 0.15s; }
    .chip.selected { ring: 2px; }
    .modal-backdrop { background: rgba(0,0,0,0.5); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- â•â•â• SIDEBAR â•â•â• -->
<div class="fixed left-0 top-0 bottom-0 w-64 bg-dark-900 text-white flex flex-col z-40">
  <!-- Logo -->
  <div class="p-5 border-b border-dark-800">
    <h1 class="text-xl font-bold text-brand-400">âš¡ ViralOps</h1>
    <p class="text-xs text-gray-400 mt-1">Content Factory â€” EMADS-PR v1.0</p>
  </div>

  <!-- Nav -->
  <nav class="flex-1 p-3 space-y-1">
    <a href="/" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'dashboard' %}bg-brand-600 text-white{% endif %}">
      <span>ğŸ“Š</span> Dashboard
    </a>
    <a href="/compose" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'compose' %}bg-brand-600 text-white{% endif %}">
      <span>âœï¸</span> Create Post
    </a>
    <a href="/content" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'content' %}bg-brand-600 text-white{% endif %}">
      <span>ğŸ“š</span> Content Library
    </a>
    <a href="/calendar" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'calendar' %}bg-brand-600 text-white{% endif %}">
      <span>ğŸ“…</span> Calendar
    </a>
    <a href="/rss" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'rss' %}bg-brand-600 text-white{% endif %}">
      <span>ğŸ“¡</span> RSS Feeds
    </a>
    <a href="/hashtags" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'hashtags' %}bg-brand-600 text-white{% endif %}">
      <span>#ï¸âƒ£</span> Hashtags
    </a>
    <a href="/analytics" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'analytics' %}bg-brand-600 text-white{% endif %}">
      <span>ğŸ“ˆ</span> Analytics
    </a>
    <a href="/engagement" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'engagement' %}bg-brand-600 text-white{% endif %}">
      <span>ğŸ’¬</span> Engagement
    </a>
    <a href="/time-slots" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'timeslots' %}bg-brand-600 text-white{% endif %}">
      <span>ğŸ•</span> Time Slots
    </a>
    <a href="/autopilot" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'autopilot' %}bg-brand-600 text-white{% endif %}">
      <span>ğŸ¤–</span> Auto-Pilot
    </a>
    <a href="/publer" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'publer' %}bg-brand-600 text-white{% endif %}">
      <span>ğŸ”—</span> Publer Bridge
    </a>
    <a href="/blog-share" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'blog-share' %}bg-brand-600 text-white{% endif %}">
      <span>ğŸ›ï¸</span> Blog Auto-Share
    </a>
    <a href="/platforms" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'platforms' %}bg-brand-600 text-white{% endif %}">
      <span>ğŸ”Œ</span> Platforms
    </a>
    <a href="/preview" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm hover:bg-dark-800 transition {% if page == 'preview' %}bg-brand-600 text-white{% endif %}">
      <span>ğŸ‘ï¸</span> Live Preview
    </a>

    <div class="pt-3 mt-3 border-t border-dark-800">
      <p class="px-3 py-1 text-xs text-gray-500 uppercase tracking-wider">Channels (16)</p>
      <div class="space-y-1 mt-1" id="sidebar-channels">
        <p class="px-3 py-1 text-xs text-gray-500">Loading...</p>
      </div>
    </div>
  </nav>

  <!-- Settings -->
  <a href="/settings" class="p-3 border-t border-dark-800 flex items-center gap-3 text-sm text-gray-400 hover:text-white transition {% if page == 'settings' %}text-brand-400{% endif %}">
    <span>âš™ï¸</span> Settings
  </a>
</div>

<!-- â•â•â• MAIN CONTENT â•â•â• -->
<main class="ml-64 p-6 min-h-screen">
  <!-- Toast container -->
  <div id="toasts" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- â•â•â• DASHBOARD PAGE â•â•â• -->
  <div class="page {% if page == 'dashboard' %}active{% endif %}" id="page-dashboard">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Dashboard</h2>

    <!-- Stats -->
    <div class="grid grid-cols-4 gap-4 mb-6" id="stats-grid">
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <p class="text-sm text-gray-500">Total Posts</p>
        <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-total">-</p>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <p class="text-sm text-gray-500">Published</p>
        <p class="text-3xl font-bold text-green-600 mt-1" id="stat-published">-</p>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <p class="text-sm text-gray-500">Scheduled</p>
        <p class="text-3xl font-bold text-blue-600 mt-1" id="stat-scheduled">-</p>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <p class="text-sm text-gray-500">Drafts</p>
        <p class="text-3xl font-bold text-amber-600 mt-1" id="stat-drafts">-</p>
      </div>
    </div>

    <!-- Channel Status -->
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold mb-3">Channel Status</h3>
        <div class="space-y-2">
          <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
            <span class="text-sm">ğŸ”´ Reddit</span>
            <button onclick="testConn('reddit')" class="text-xs bg-brand-500 text-white px-3 py-1 rounded-full hover:bg-brand-600">Test</button>
          </div>
          <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
            <span class="text-sm">ğŸŸ¢ Medium</span>
            <button onclick="testConn('medium')" class="text-xs bg-brand-500 text-white px-3 py-1 rounded-full hover:bg-brand-600">Test</button>
          </div>
          <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
            <span class="text-sm">ğŸ”µ Tumblr</span>
            <button onclick="testConn('tumblr')" class="text-xs bg-brand-500 text-white px-3 py-1 rounded-full hover:bg-brand-600">Test</button>
          </div>
          <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
            <span class="text-sm">ğŸŸ© Shopify Blog</span>
            <button onclick="testConn('shopify_blog')" class="text-xs bg-brand-500 text-white px-3 py-1 rounded-full hover:bg-brand-600">Test</button>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold mb-3">Scheduler Status</h3>
        <div id="scheduler-status" class="space-y-3">
          <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
            <span class="text-sm">Background scheduler running</span>
          </div>
          <p class="text-xs text-gray-500">Checks every 60 seconds for scheduled posts</p>
          <button onclick="triggerScheduler()" class="text-xs bg-amber-500 text-white px-4 py-1.5 rounded-full hover:bg-amber-600">Run Now</button>
        </div>
        <div class="mt-4 pt-3 border-t">
          <h4 class="font-semibold text-sm mb-2">Budget</h4>
          <div id="budget-info" class="text-xs text-gray-500">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Recent Posts -->
    <div class="bg-white rounded-xl p-5 shadow-sm border">
      <h3 class="font-semibold mb-3">Recent Posts</h3>
      <div id="recent-posts" class="space-y-2">Loading...</div>
    </div>
  </div>

  <!-- â•â•â• COMPOSE PAGE â•â•â• -->
  <div class="page {% if page == 'compose' %}active{% endif %}" id="page-compose">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Create Post</h2>
    <div class="max-w-4xl">
      <div class="bg-white rounded-xl p-6 shadow-sm border">
        <!-- Platforms (dynamic 16) -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Platforms <span class="text-xs text-gray-400" id="compose-plat-count">(0 selected)</span></label>
          <div class="flex gap-2 mb-2">
            <button type="button" onclick="selectAllPlatforms()" class="text-xs bg-brand-100 text-brand-700 px-3 py-1 rounded-full hover:bg-brand-200">Select All Configured</button>
            <button type="button" onclick="clearAllPlatforms()" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200">Clear All</button>
          </div>
          <div class="flex flex-wrap gap-2" id="platform-chips">Loading platforms...</div>
        </div>

        <!-- Title -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
          <input id="post-title" type="text" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 focus:border-transparent" placeholder="Enter post title...">
        </div>

        <!-- Body -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Body</label>
          <textarea id="post-body" rows="10" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 focus:border-transparent font-mono text-sm" placeholder="Write your content here..."></textarea>
          <div class="flex justify-between text-xs text-gray-400 mt-1">
            <span id="char-count">0 characters</span>
            <span id="word-count">0 words</span>
          </div>
        </div>

        <!-- Category -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
          <select id="post-category" class="border rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
            {% if categories %}{% for c in categories %}<option value="{{ c.name }}">{{ c.icon }} {{ c.name }}</option>{% endfor %}{% else %}
            <option value="general">ğŸ“ general</option><option value="blog">ğŸ“° blog</option><option value="promotion">ğŸ”¥ promotion</option><option value="evergreen">ğŸŒ² evergreen</option><option value="curated">â­ curated</option>
            {% endif %}
          </select>
        </div>

        <!-- Schedule -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Schedule (optional)</label>
          <input id="post-schedule" type="datetime-local" class="border rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
        </div>

        <!-- Platform-specific fields (dynamic) -->
        <div id="extra-fields" class="space-y-4 mb-4"></div>

        <!-- Per-platform character limits -->
        <div id="compose-limits" class="mb-4 hidden">
          <label class="block text-sm font-medium text-gray-700 mb-1">Character Limits</label>
          <div class="flex flex-wrap gap-2 text-xs" id="compose-limit-badges"></div>
        </div>

        <!-- Hashtag Selector -->
        <div class="mb-4 bg-purple-50 rounded-lg p-4">
          <h4 class="font-medium text-purple-800 mb-2">#ï¸âƒ£ Hashtag Collections</h4>
          <div id="hashtag-selector" class="flex flex-wrap gap-2 mb-2">Loading...</div>
          <div class="flex gap-2">
            <button onclick="generateHashtags()" class="text-xs bg-purple-500 text-white px-3 py-1.5 rounded-full hover:bg-purple-600">ğŸ² Generate Auto</button>
            <input id="custom-hashtag" placeholder="Add custom #hashtag" class="text-xs border rounded-full px-3 py-1">
            <button onclick="addCustomHashtag()" class="text-xs bg-gray-500 text-white px-3 py-1.5 rounded-full hover:bg-gray-600">Add</button>
          </div>
          <div id="selected-hashtags" class="mt-2 text-sm text-purple-700"></div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3">
          <button onclick="savePost('draft')" class="px-5 py-2.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-medium">Save Draft</button>
          <button onclick="savePost('scheduled')" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-medium">ğŸ“… Schedule</button>
          <button onclick="publishNow()" class="px-5 py-2.5 bg-brand-500 text-white rounded-lg hover:bg-brand-600 font-medium">ğŸš€ Publish Now</button>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• CONTENT LIBRARY PAGE â•â•â• -->
  <div class="page {% if page == 'content' %}active{% endif %}" id="page-content">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800">Content Library</h2>
      <span class="text-sm text-gray-400" id="content-total"></span>
    </div>
    <div class="flex justify-between items-center mb-4">
      <div class="flex gap-2">
        <button onclick="filterPosts('all')" class="px-4 py-1.5 rounded-full text-sm bg-brand-500 text-white" id="cf-all">All</button>
        <button onclick="filterPosts('draft')" class="px-4 py-1.5 rounded-full text-sm bg-gray-200 hover:bg-gray-300" id="cf-draft">Drafts</button>
        <button onclick="filterPosts('scheduled')" class="px-4 py-1.5 rounded-full text-sm bg-gray-200 hover:bg-gray-300" id="cf-scheduled">Scheduled</button>
        <button onclick="filterPosts('published')" class="px-4 py-1.5 rounded-full text-sm bg-gray-200 hover:bg-gray-300" id="cf-published">Published</button>
        <button onclick="filterPosts('failed')" class="px-4 py-1.5 rounded-full text-sm bg-gray-200 hover:bg-gray-300" id="cf-failed">Failed</button>
      </div>
    </div>
    <!-- Bulk Actions Bar -->
    <div id="bulk-bar" class="hidden mb-4 bg-brand-50 rounded-xl p-3 border border-brand-200 flex items-center gap-3">
      <span class="text-sm font-medium text-brand-700" id="bulk-count">0 selected</span>
      <button onclick="bulkPublish()" class="text-xs bg-brand-500 text-white px-4 py-1.5 rounded-full hover:bg-brand-600">ğŸš€ Publish Selected</button>
      <button onclick="bulkDelete()" class="text-xs bg-red-500 text-white px-4 py-1.5 rounded-full hover:bg-red-600">ğŸ—‘ï¸ Delete Selected</button>
      <button onclick="bulkSchedule()" class="text-xs bg-blue-500 text-white px-4 py-1.5 rounded-full hover:bg-blue-600">ğŸ“… Schedule Selected</button>
      <button onclick="clearBulk()" class="text-xs text-gray-500 hover:text-gray-700 ml-auto">âœ• Clear</button>
    </div>
    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-50"><tr>
          <th class="px-3 py-3 text-center w-10"><input type="checkbox" id="select-all-posts" onchange="toggleSelectAll(this)"></th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Content</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Platforms</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr></thead>
        <tbody id="content-table">
          <tr><td colspan="7" class="px-4 py-8 text-center text-gray-400">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- â•â•â• CALENDAR PAGE â•â•â• -->
  <div class="page {% if page == 'calendar' %}active{% endif %}" id="page-calendar">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800">Calendar</h2>
      <div class="flex items-center gap-3">
        <button onclick="calNav(-1)" class="p-2 rounded-lg hover:bg-gray-100">â—€</button>
        <span id="cal-month" class="text-lg font-medium"></span>
        <button onclick="calNav(1)" class="p-2 rounded-lg hover:bg-gray-100">â–¶</button>
      </div>
    </div>
    <div class="bg-white rounded-xl shadow-sm border p-4">
      <div class="grid grid-cols-7 gap-1 mb-2">
        <div class="text-center text-xs font-medium text-gray-500 py-2">Sun</div>
        <div class="text-center text-xs font-medium text-gray-500 py-2">Mon</div>
        <div class="text-center text-xs font-medium text-gray-500 py-2">Tue</div>
        <div class="text-center text-xs font-medium text-gray-500 py-2">Wed</div>
        <div class="text-center text-xs font-medium text-gray-500 py-2">Thu</div>
        <div class="text-center text-xs font-medium text-gray-500 py-2">Fri</div>
        <div class="text-center text-xs font-medium text-gray-500 py-2">Sat</div>
      </div>
      <div id="cal-grid" class="grid grid-cols-7 gap-1"></div>
    </div>
  </div>

  <!-- â•â•â• RSS FEEDS PAGE â•â•â• -->
  <div class="page {% if page == 'rss' %}active{% endif %}" id="page-rss">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“¡ RSS Feed Manager</h2>

    <!-- Add Feed -->
    <div class="bg-white rounded-xl p-5 shadow-sm border mb-6">
      <h3 class="font-semibold mb-3">Add RSS Feed</h3>
      <div class="flex gap-3 mb-3">
        <input id="rss-url" type="url" placeholder="https://example.com/feed.xml" class="flex-1 border rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
        <input id="rss-name" placeholder="Feed name" class="w-48 border rounded-lg px-3 py-2">
        <select id="rss-mode" class="border rounded-lg px-3 py-2">
          <option value="full">Full Content</option>
          <option value="excerpt">Excerpt Only</option>
        </select>
      </div>
      <div class="flex gap-3">
        <button onclick="previewFeed()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm">ğŸ‘ï¸ Preview</button>
        <button onclick="addFeed()" class="px-4 py-2 bg-brand-500 text-white rounded-lg hover:bg-brand-600 text-sm">â• Add Feed</button>
      </div>
    </div>

    <!-- Feed Preview -->
    <div id="rss-preview" class="bg-white rounded-xl p-5 shadow-sm border mb-6 hidden">
      <h3 class="font-semibold mb-3">Feed Preview</h3>
      <div id="rss-preview-content"></div>
    </div>

    <!-- Active Feeds -->
    <div class="bg-white rounded-xl p-5 shadow-sm border mb-6">
      <h3 class="font-semibold mb-3">Active Feeds</h3>
      <div id="rss-feeds-list" class="space-y-3">Loading...</div>
    </div>

    <!-- Imported Entries -->
    <div class="bg-white rounded-xl p-5 shadow-sm border">
      <h3 class="font-semibold mb-3">Latest Entries</h3>
      <div id="rss-entries" class="space-y-3">Click "Fetch" on a feed to load entries.</div>
    </div>
  </div>

  <!-- â•â•â• HASHTAGS PAGE â•â•â• -->
  <div class="page {% if page == 'hashtags' %}active{% endif %}" id="page-hashtags">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">#ï¸âƒ£ Hashtag Collections</h2>

    <!-- Create Collection -->
    <div class="bg-white rounded-xl p-5 shadow-sm border mb-6">
      <h3 class="font-semibold mb-3">Create Collection</h3>
      <div class="grid grid-cols-2 gap-3 mb-3">
        <input id="htag-name" placeholder="Collection name" class="border rounded-lg px-3 py-2">
        <input id="htag-niche" placeholder="Niche (e.g., plant_based_raw)" class="border rounded-lg px-3 py-2">
      </div>
      <textarea id="htag-tags" rows="3" placeholder="Enter hashtags, one per line or comma-separated" class="w-full border rounded-lg px-3 py-2 mb-3 font-mono text-sm"></textarea>
      <div class="flex gap-3">
        <button onclick="generateHashtagCollection()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm">ğŸ² Auto-Generate</button>
        <button onclick="saveHashtagCollection()" class="px-4 py-2 bg-brand-500 text-white rounded-lg hover:bg-brand-600 text-sm">ğŸ’¾ Save Collection</button>
      </div>
    </div>

    <!-- Collections List -->
    <div class="bg-white rounded-xl p-5 shadow-sm border">
      <h3 class="font-semibold mb-3">Saved Collections</h3>
      <div id="hashtag-collections" class="space-y-3">Loading...</div>
    </div>
  </div>

  <!-- â•â•â• ANALYTICS PAGE â•â•â• -->
  <div class="page {% if page == 'analytics' %}active{% endif %}" id="page-analytics">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800">Analytics</h2>
      <div class="flex gap-2">
        <button onclick="setAnalyticsPeriod(7)" class="px-3 py-1.5 text-xs rounded-full bg-gray-200 hover:bg-brand-100" id="ap-7">7 days</button>
        <button onclick="setAnalyticsPeriod(30)" class="px-3 py-1.5 text-xs rounded-full bg-brand-500 text-white" id="ap-30">30 days</button>
        <button onclick="setAnalyticsPeriod(90)" class="px-3 py-1.5 text-xs rounded-full bg-gray-200 hover:bg-brand-100" id="ap-90">90 days</button>
      </div>
    </div>
    <div class="grid grid-cols-5 gap-4 mb-6" id="analytics-stats">
      <div class="bg-white rounded-xl p-4 shadow-sm border text-center">
        <p class="text-2xl font-bold text-gray-800" id="a-total">-</p>
        <p class="text-xs text-gray-500">Total Published</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm border text-center">
        <p class="text-2xl font-bold text-green-600" id="a-success">-</p>
        <p class="text-xs text-gray-500">Successful</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm border text-center">
        <p class="text-2xl font-bold text-red-600" id="a-failed">-</p>
        <p class="text-xs text-gray-500">Failed</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm border text-center">
        <p class="text-2xl font-bold text-brand-600" id="a-rate">-</p>
        <p class="text-xs text-gray-500">Success Rate</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm border text-center">
        <p class="text-2xl font-bold text-amber-600" id="a-platforms">-</p>
        <p class="text-xs text-gray-500">Platforms</p>
      </div>
    </div>
    <!-- Charts Row -->
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold mb-3">ğŸ“ˆ Publishing Trend</h3>
        <canvas id="chart-trend" height="200"></canvas>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold mb-3">ğŸ“Š Platform Comparison</h3>
        <canvas id="chart-platforms" height="200"></canvas>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold mb-3">ğŸ† Top Performing Posts</h3>
        <div id="top-posts" class="space-y-2 max-h-72 overflow-y-auto"></div>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold mb-3">â° Post Activity by Hour</h3>
        <canvas id="chart-hours" height="200"></canvas>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold mb-3">Platform Performance</h3>
        <div id="platform-bars"></div>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold mb-3">Recent Publish Log</h3>
        <div id="publish-log" class="space-y-2 max-h-80 overflow-y-auto"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â• SETTINGS PAGE â•â•â• -->
  <div class="page {% if page == 'settings' %}active{% endif %}" id="page-settings">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Settings</h2>
    <div class="grid grid-cols-2 gap-4">
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold text-orange-600 mb-3">ğŸ”´ Reddit</h3>
        <div class="space-y-2 text-sm text-gray-600">
          <p>âœ… REDDIT_CLIENT_ID</p><p>âœ… REDDIT_CLIENT_SECRET</p>
          <p>âœ… REDDIT_USERNAME</p><p>âœ… REDDIT_PASSWORD</p>
        </div>
        <button onclick="testConn('reddit')" class="mt-3 text-xs bg-orange-500 text-white px-4 py-1.5 rounded-full">Test Connection</button>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold text-green-600 mb-3">ğŸŸ¢ Medium</h3>
        <div class="space-y-2 text-sm text-gray-600">
          <p>âœ… MEDIUM_TOKEN</p>
        </div>
        <button onclick="testConn('medium')" class="mt-3 text-xs bg-green-500 text-white px-4 py-1.5 rounded-full">Test Connection</button>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold text-blue-600 mb-3">ğŸ”µ Tumblr</h3>
        <div class="space-y-2 text-sm text-gray-600">
          <p>âœ… TUMBLR_ACCESS_TOKEN</p><p>âœ… TUMBLR_BLOG_NAME</p>
        </div>
        <button onclick="testConn('tumblr')" class="mt-3 text-xs bg-blue-500 text-white px-4 py-1.5 rounded-full">Test Connection</button>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold text-emerald-600 mb-3">ğŸŸ© Shopify Blog</h3>
        <div class="space-y-2 text-sm text-gray-600">
          <p>âœ… SHOPIFY_STORE</p><p>âœ… SHOPIFY_ACCESS_TOKEN</p><p>âœ… SHOPIFY_BLOG_ID</p>
        </div>
        <button onclick="testConn('shopify_blog')" class="mt-3 text-xs bg-emerald-500 text-white px-4 py-1.5 rounded-full">Test Connection</button>
      </div>
    </div>
  </div>

  <!-- â•â•â• PLATFORMS PAGE â•â•â• -->
  <div class="page {% if page == 'platforms' %}active{% endif %}" id="page-platforms">
    <h2 class="text-2xl font-bold text-gray-800 mb-2">Platform Setup</h2>
    <p class="text-gray-500 mb-6">Configure API keys for each platform. See <a href="https://github.com/rozy0311/viralops-engine/blob/main/SETUP_GUIDE.md" target="_blank" class="text-brand-500 underline">SETUP_GUIDE.md</a> for step-by-step instructions.</p>

    <!-- Summary Cards -->
    <div class="grid grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <p class="text-sm text-gray-500">Total Platforms</p>
        <p class="text-3xl font-bold text-gray-800 mt-1" id="plat-total">-</p>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <p class="text-sm text-gray-500">Configured âœ…</p>
        <p class="text-3xl font-bold text-green-600 mt-1" id="plat-configured">-</p>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <p class="text-sm text-gray-500">Not Configured âŒ</p>
        <p class="text-3xl font-bold text-red-500 mt-1" id="plat-missing">-</p>
      </div>
    </div>

    <!-- Difficulty Filter -->
    <div class="flex gap-2 mb-4">
      <button onclick="filterPlatforms('all')" class="px-4 py-1.5 text-sm rounded-full bg-gray-200 hover:bg-gray-300 font-medium">All</button>
      <button onclick="filterPlatforms('easy')" class="px-4 py-1.5 text-sm rounded-full bg-green-100 text-green-700 hover:bg-green-200 font-medium">ğŸŸ¢ Easy</button>
      <button onclick="filterPlatforms('medium')" class="px-4 py-1.5 text-sm rounded-full bg-yellow-100 text-yellow-700 hover:bg-yellow-200 font-medium">ğŸŸ¡ Medium</button>
      <button onclick="filterPlatforms('hard')" class="px-4 py-1.5 text-sm rounded-full bg-red-100 text-red-700 hover:bg-red-200 font-medium">ğŸ”´ Hard</button>
    </div>

    <!-- Platform Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="platforms-grid">
      <p class="text-gray-400 col-span-full text-center py-8">Loading platforms...</p>
    </div>
  </div>

  <!-- â•â•â• ENGAGEMENT PAGE â•â•â• -->
  <div class="page {% if page == 'engagement' %}active{% endif %}" id="page-engagement">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">Engagement Dashboard</h2>
        <p class="text-gray-500">Real metrics pulled from all connected platforms</p>
      </div>
      <button onclick="fetchEngagement()" class="bg-brand-500 text-white px-4 py-2 rounded-lg hover:bg-brand-600 text-sm font-medium">
        ğŸ”„ Fetch Latest
      </button>
    </div>

    <!-- Engagement Stats -->
    <div class="grid grid-cols-5 gap-4 mb-6">
      <div class="bg-white rounded-xl p-4 shadow-sm border text-center">
        <p class="text-xs text-gray-500">Total Likes</p>
        <p class="text-2xl font-bold text-pink-500 mt-1" id="eng-likes">-</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm border text-center">
        <p class="text-xs text-gray-500">Total Shares</p>
        <p class="text-2xl font-bold text-blue-500 mt-1" id="eng-shares">-</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm border text-center">
        <p class="text-xs text-gray-500">Total Comments</p>
        <p class="text-2xl font-bold text-green-500 mt-1" id="eng-comments">-</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm border text-center">
        <p class="text-xs text-gray-500">Total Views</p>
        <p class="text-2xl font-bold text-purple-500 mt-1" id="eng-views">-</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm border text-center">
        <p class="text-xs text-gray-500">Posts Tracked</p>
        <p class="text-2xl font-bold text-gray-700 mt-1" id="eng-posts">-</p>
      </div>
    </div>

    <!-- Platform Filter -->
    <div class="flex gap-2 mb-4 flex-wrap">
      <button onclick="loadEngagement()" class="px-3 py-1 text-xs rounded-full bg-gray-200 hover:bg-gray-300 font-medium">All Platforms</button>
      <button onclick="loadEngagement('twitter')" class="px-3 py-1 text-xs rounded-full bg-sky-100 text-sky-700 hover:bg-sky-200">Twitter</button>
      <button onclick="loadEngagement('instagram')" class="px-3 py-1 text-xs rounded-full bg-pink-100 text-pink-700 hover:bg-pink-200">Instagram</button>
      <button onclick="loadEngagement('tiktok')" class="px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200">TikTok</button>
      <button onclick="loadEngagement('reddit')" class="px-3 py-1 text-xs rounded-full bg-orange-100 text-orange-700 hover:bg-orange-200">Reddit</button>
      <button onclick="loadEngagement('bluesky')" class="px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200">Bluesky</button>
      <button onclick="loadEngagement('mastodon')" class="px-3 py-1 text-xs rounded-full bg-indigo-100 text-indigo-700 hover:bg-indigo-200">Mastodon</button>
      <button onclick="loadEngagement('linkedin')" class="px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200">LinkedIn</button>
      <button onclick="loadEngagement('medium')" class="px-3 py-1 text-xs rounded-full bg-green-100 text-green-700 hover:bg-green-200">Medium</button>
    </div>

    <!-- Engagement Table -->
    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
      <table class="w-full text-sm">
        <thead class="bg-gray-50 border-b">
          <tr>
            <th class="text-left px-4 py-3 font-medium text-gray-600">Platform</th>
            <th class="text-right px-4 py-3 font-medium text-gray-600">â¤ï¸ Likes</th>
            <th class="text-right px-4 py-3 font-medium text-gray-600">ğŸ”„ Shares</th>
            <th class="text-right px-4 py-3 font-medium text-gray-600">ğŸ’¬ Comments</th>
            <th class="text-right px-4 py-3 font-medium text-gray-600">ğŸ‘ï¸ Views</th>
            <th class="text-right px-4 py-3 font-medium text-gray-600">Posts</th>
          </tr>
        </thead>
        <tbody id="engagement-table">
          <tr><td colspan="6" class="text-center py-8 text-gray-400">Click "Fetch Latest" to pull engagement data</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- â•â•â• TIME SLOTS PAGE â•â•â• -->
  <div class="page {% if page == 'timeslots' %}active{% endif %}" id="page-timeslots">
    <h2 class="text-2xl font-bold text-gray-800 mb-2">Optimal Posting Times</h2>
    <p class="text-gray-500 mb-6">AI-suggested posting schedule based on platform data + your analytics</p>

    <!-- Quick Suggest -->
    <div class="grid grid-cols-2 gap-6 mb-6">
      <!-- Single Platform Suggest -->
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold mb-3">ğŸ• Quick Suggest</h3>
        <p class="text-xs text-gray-500 mb-3">Get the next best time for a specific platform</p>
        <div class="flex gap-2">
          <select id="ts-platform" class="flex-1 border rounded-lg px-3 py-2 text-sm">
            <option value="twitter">Twitter</option>
            <option value="instagram">Instagram</option>
            <option value="tiktok">TikTok</option>
            <option value="facebook">Facebook</option>
            <option value="linkedin">LinkedIn</option>
            <option value="youtube">YouTube</option>
            <option value="reddit">Reddit</option>
            <option value="pinterest">Pinterest</option>
            <option value="medium">Medium</option>
            <option value="tumblr">Tumblr</option>
            <option value="threads">Threads</option>
            <option value="bluesky">Bluesky</option>
            <option value="mastodon">Mastodon</option>
            <option value="quora">Quora</option>
            <option value="shopify_blog">Shopify Blog</option>
          </select>
          <button onclick="suggestTime()" class="bg-brand-500 text-white px-4 py-2 rounded-lg hover:bg-brand-600 text-sm">Suggest</button>
        </div>
        <div id="ts-result" class="mt-3 hidden">
          <div class="bg-brand-50 rounded-lg p-3">
            <p class="text-sm font-medium text-brand-700" id="ts-result-text">-</p>
          </div>
        </div>
      </div>

      <!-- Schedule Generator -->
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <h3 class="font-semibold mb-3">ğŸ“… Daily Schedule Generator</h3>
        <p class="text-xs text-gray-500 mb-3">Generate a full day schedule across platforms</p>
        <div class="space-y-2">
          <div class="flex gap-2">
            <input type="number" id="ts-posts-per" value="2" min="1" max="10" class="w-20 border rounded-lg px-3 py-2 text-sm" placeholder="Posts">
            <span class="text-sm text-gray-500 self-center">posts per platform</span>
          </div>
          <div class="flex gap-2">
            <input type="number" id="ts-utc" value="7" min="-12" max="14" class="w-20 border rounded-lg px-3 py-2 text-sm" placeholder="UTC">
            <span class="text-sm text-gray-500 self-center">UTC offset (e.g. 7 = Vietnam)</span>
          </div>
          <button onclick="generateSchedule()" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 text-sm font-medium">Generate Schedule</button>
        </div>
      </div>
    </div>

    <!-- Best Hours -->
    <div class="bg-white rounded-xl p-5 shadow-sm border mb-6">
      <h3 class="font-semibold mb-3">ğŸ† Best Posting Hours (All Platforms)</h3>
      <div id="best-hours-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-3">
        <p class="text-gray-400 col-span-full text-center py-4">Loading...</p>
      </div>
    </div>

    <!-- Generated Schedule -->
    <div id="schedule-result" class="hidden">
      <h3 class="font-semibold mb-3">ğŸ“‹ Generated Schedule</h3>
      <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 border-b">
            <tr>
              <th class="text-left px-4 py-3 font-medium text-gray-600">Time</th>
              <th class="text-left px-4 py-3 font-medium text-gray-600">Platform</th>
              <th class="text-left px-4 py-3 font-medium text-gray-600">Source</th>
              <th class="text-right px-4 py-3 font-medium text-gray-600">Confidence</th>
            </tr>
          </thead>
          <tbody id="schedule-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â•â•â• AUTO-PILOT PAGE â•â•â• -->
  <div class="page {% if page == 'autopilot' %}active{% endif %}" id="page-autopilot">
    <h2 class="text-2xl font-bold text-gray-800 mb-2">ğŸ¤– Auto-Pilot</h2>
    <p class="text-gray-500 text-sm mb-6">Pick a niche â†’ AI generates content â†’ best times â†’ schedule across all platforms â†’ one click.</p>

    <div class="grid grid-cols-3 gap-6">
      <!-- Step 1: Config -->
      <div class="col-span-1 space-y-4">
        <div class="bg-white rounded-xl p-5 shadow-sm border">
          <h3 class="font-semibold mb-3">â‘  Niche & Topic</h3>
          <select id="ap-niche" class="w-full border rounded-lg px-3 py-2 mb-3">
            <option value="plant_based_raw">ğŸ¥¬ Plant-Based Raw</option>
            <option value="sustainable_living">â™»ï¸ Sustainable Living</option>
            <option value="fitness_wellness">ğŸ’ª Fitness & Wellness</option>
            <option value="tech_ai">ğŸ¤– Tech & AI</option>
            <option value="digital_marketing">ğŸ“ˆ Digital Marketing</option>
            <option value="personal_finance">ğŸ’° Personal Finance</option>
            <option value="travel">âœˆï¸ Travel</option>
            <option value="food_cooking">ğŸ³ Food & Cooking</option>
            <option value="mental_health">ğŸ§  Mental Health</option>
            <option value="ecommerce">ğŸ›’ E-Commerce</option>
            <option value="general">ğŸ“ General</option>
          </select>
          <input id="ap-topic" placeholder="Specific topic (optional)" class="w-full border rounded-lg px-3 py-2 mb-3">
          <div class="text-xs text-gray-400">Leave topic empty for AI to pick a trending angle.</div>
        </div>

        <div class="bg-white rounded-xl p-5 shadow-sm border">
          <h3 class="font-semibold mb-3">â‘¡ Platforms</h3>
          <div id="ap-platforms" class="space-y-2"></div>
          <div class="flex gap-2 mt-3">
            <button onclick="apSelectAll()" class="text-xs bg-brand-100 text-brand-700 px-3 py-1 rounded-full">Select All</button>
            <button onclick="apClearAll()" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full">Clear</button>
          </div>
        </div>

        <div class="bg-white rounded-xl p-5 shadow-sm border">
          <h3 class="font-semibold mb-3">â‘¢ Settings</h3>
          <label class="block text-xs text-gray-500 mb-1">Posts per platform</label>
          <input id="ap-posts-per" type="number" value="1" min="1" max="5" class="w-full border rounded-lg px-3 py-2 mb-3">
          <label class="block text-xs text-gray-500 mb-1">UTC offset (your timezone)</label>
          <input id="ap-utc" type="number" value="7" min="-12" max="14" class="w-full border rounded-lg px-3 py-2 mb-3">
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" id="ap-auto-hashtags" checked> Auto-generate hashtags
          </label>
          <label class="flex items-center gap-2 text-sm mt-2">
            <input type="checkbox" id="ap-best-times" checked> Use best-time scheduling
          </label>
        </div>

        <button onclick="runAutoPilot()" class="w-full py-3 bg-gradient-to-r from-brand-500 to-purple-500 text-white rounded-xl font-bold text-lg hover:from-brand-600 hover:to-purple-600 shadow-lg">
          ğŸš€ Launch Auto-Pilot
        </button>
      </div>

      <!-- Step 2: Preview & Results -->
      <div class="col-span-2 space-y-4">
        <!-- Progress -->
        <div id="ap-progress" class="hidden">
          <div class="bg-white rounded-xl p-5 shadow-sm border">
            <h3 class="font-semibold mb-3">âš¡ Auto-Pilot Progress</h3>
            <div class="space-y-2" id="ap-steps">
              <div class="flex items-center gap-3 text-sm" id="ap-step-content"><span class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs">1</span> Generating content...</div>
              <div class="flex items-center gap-3 text-sm text-gray-400" id="ap-step-hashtags"><span class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs">2</span> Generating hashtags...</div>
              <div class="flex items-center gap-3 text-sm text-gray-400" id="ap-step-schedule"><span class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs">3</span> Finding best times...</div>
              <div class="flex items-center gap-3 text-sm text-gray-400" id="ap-step-save"><span class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs">4</span> Saving & scheduling posts...</div>
            </div>
          </div>
        </div>

        <!-- Generated Content Preview -->
        <div id="ap-result" class="hidden">
          <div class="bg-white rounded-xl p-5 shadow-sm border mb-4">
            <h3 class="font-semibold mb-3">ğŸ“ Generated Content</h3>
            <div class="space-y-3">
              <div><label class="text-xs text-gray-500">Title</label><p class="font-medium" id="ap-gen-title"></p></div>
              <div><label class="text-xs text-gray-500">Body</label><p class="text-sm whitespace-pre-wrap bg-gray-50 rounded-lg p-3" id="ap-gen-body"></p></div>
              <div><label class="text-xs text-gray-500">Hashtags</label><div class="flex flex-wrap gap-1" id="ap-gen-tags"></div></div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-5 shadow-sm border mb-4">
            <h3 class="font-semibold mb-3">ğŸ“… Schedule Plan</h3>
            <div class="space-y-2" id="ap-schedule-list"></div>
          </div>
          <div class="flex gap-3">
            <button onclick="apConfirmPublish()" class="px-6 py-2.5 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600">âœ… Confirm & Schedule All</button>
            <button onclick="apEditAndPublish()" class="px-6 py-2.5 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600">âœï¸ Edit in Compose</button>
            <button onclick="apRegenerate()" class="px-6 py-2.5 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600">ğŸ”„ Regenerate</button>
          </div>
        </div>

        <!-- Empty state -->
        <div id="ap-empty" class="bg-white rounded-xl p-12 shadow-sm border text-center">
          <div class="text-6xl mb-4">ğŸ¤–</div>
          <h3 class="text-xl font-bold text-gray-700 mb-2">Ready for Auto-Pilot</h3>
          <p class="text-gray-400">Configure your niche, select platforms, and click Launch.</p>
          <p class="text-gray-400 text-sm mt-2">AI will generate content, pick optimal posting times, and schedule everything automatically.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• PUBLER BRIDGE PAGE â•â•â• -->
  <div class="page {% if page == 'publer' %}active{% endif %}" id="page-publer">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ”— Publer Bridge</h2>
    <p class="text-gray-400 mb-6">Post to TikTok, Instagram, Facebook & more via Publer REST API (~$10/mo per account) â€” zero bot detection risk.</p>

    <!-- Connection Status -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-dark-900 rounded-xl p-6 border border-dark-700">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-white">Connection Status</h3>
          <span id="snd-status-badge" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-700 text-gray-400">Checking...</span>
        </div>
        <div id="snd-status-info" class="text-sm text-gray-400">
          <p>Checking Publer API connection...</p>
        </div>
        <button onclick="testPublerConnection()" class="mt-4 w-full bg-brand-600 hover:bg-brand-700 text-white py-2 px-4 rounded-lg text-sm transition">
          ğŸ”Œ Test Connection
        </button>
      </div>

      <div class="bg-dark-900 rounded-xl p-6 border border-dark-700">
        <h3 class="font-semibold text-white mb-4">API Configuration</h3>
        <div id="snd-auth-mode" class="text-sm text-gray-400">
          <p>Loading...</p>
        </div>
      </div>

      <div class="bg-dark-900 rounded-xl p-6 border border-dark-700">
        <h3 class="font-semibold text-white mb-4">Workspace Info</h3>
        <div id="snd-account-info" class="text-sm text-gray-400">
          <p>Connect first to see workspace details</p>
        </div>
      </div>
    </div>

    <!-- Connected Accounts -->
    <div class="bg-dark-900 rounded-xl p-6 border border-dark-700 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold text-white">Connected Accounts</h3>
        <button onclick="refreshPublerAccounts()" class="bg-dark-700 hover:bg-dark-600 text-white py-1.5 px-4 rounded-lg text-sm transition">
          ğŸ”„ Refresh
        </button>
      </div>
      <p class="text-sm text-gray-500 mb-4">Social accounts connected in your Publer workspace. ViralOps auto-detects all accounts.</p>
      <div id="snd-services-grid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <p class="text-gray-500 text-sm col-span-4">Connect to Publer to see accounts...</p>
      </div>
    </div>

    <!-- Quick Publish via Publer -->
    <div class="bg-dark-900 rounded-xl p-6 border border-dark-700 mb-8">
      <h3 class="font-semibold text-white mb-4">ğŸ“ Quick Publish via Publer</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">Message</label>
          <textarea id="snd-message" rows="4" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-4 py-2.5 text-white text-sm" placeholder="Write your post content..."></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Target Platforms (comma-separated)</label>
            <input id="snd-platforms" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-4 py-2.5 text-white text-sm" placeholder="e.g. instagram,tiktok,facebook (blank = all)">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Schedule (optional)</label>
            <input type="datetime-local" id="snd-schedule" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-4 py-2.5 text-white text-sm">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Media URL (optional)</label>
            <input id="snd-media" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-4 py-2.5 text-white text-sm" placeholder="https://example.com/image.jpg">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Hashtags (comma-separated)</label>
            <input id="snd-hashtags" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-4 py-2.5 text-white text-sm" placeholder="e.g. fitness,health,workout">
          </div>
        </div>
        <div class="flex gap-3">
          <button onclick="publerPublish(false)" class="bg-brand-600 hover:bg-brand-700 text-white py-2.5 px-6 rounded-lg text-sm font-medium transition">
            ğŸš€ Publish Now
          </button>
          <button onclick="publerPublish(true)" class="bg-purple-600 hover:bg-purple-700 text-white py-2.5 px-6 rounded-lg text-sm font-medium transition">
            ğŸ“… Schedule
          </button>
        </div>
        <div id="snd-publish-result" class="hidden mt-4 p-4 rounded-lg text-sm"></div>
      </div>
    </div>

    <!-- Workspaces -->
    <div class="bg-dark-900 rounded-xl p-6 border border-dark-700">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold text-white">Workspaces</h3>
        <button onclick="loadPublerWorkspaces()" class="bg-dark-700 hover:bg-dark-600 text-white py-1.5 px-4 rounded-lg text-sm transition">
          ğŸ”„ Refresh
        </button>
      </div>
      <div id="snd-messages-list" class="space-y-3">
        <p class="text-gray-500 text-sm">No workspaces loaded yet.</p>
      </div>
    </div>

    <!-- Setup Guide -->
    <div class="bg-dark-900 rounded-xl p-6 border border-dark-700 mt-8">
      <h3 class="font-semibold text-white mb-4">ğŸ“– Setup Guide</h3>
      <div class="space-y-3 text-sm text-gray-400">
        <div class="flex items-start gap-3">
          <span class="bg-brand-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs flex-shrink-0">1</span>
          <p>Sign up at <a href="https://publer.io" target="_blank" class="text-brand-400 underline">publer.io</a> and connect your social accounts (TikTok, Instagram, Facebook, etc.)</p>
        </div>
        <div class="flex items-start gap-3">
          <span class="bg-brand-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs flex-shrink-0">2</span>
          <p>Go to <strong class="text-white">Settings â†’ API Access</strong> and generate your <strong class="text-white">API Key</strong></p>
        </div>
        <div class="flex items-start gap-3">
          <span class="bg-brand-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs flex-shrink-0">3</span>
          <p>Copy your <strong class="text-white">Workspace ID</strong> from the workspace URL or API response</p>
        </div>
        <div class="flex items-start gap-3">
          <span class="bg-brand-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs flex-shrink-0">4</span>
          <p>Add <code class="bg-dark-800 px-2 py-0.5 rounded text-brand-400">PUBLER_API_KEY</code> and <code class="bg-dark-800 px-2 py-0.5 rounded text-brand-400">PUBLER_WORKSPACE_ID</code> to your <code class="bg-dark-800 px-2 py-0.5 rounded text-brand-400">.env</code> file</p>
        </div>
        <div class="flex items-start gap-3">
          <span class="bg-brand-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs flex-shrink-0">5</span>
          <p>Click <strong class="text-white">Test Connection</strong> above â€” ViralOps will auto-detect all accounts!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• BLOG AUTO-SHARE PAGE â•â•â• -->
  <div class="page {% if page == 'blog-share' %}active{% endif %}" id="page-blog-share">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ›ï¸ Shopify Blog Auto-Share</h2>
    <p class="text-gray-500 mb-6">Automatically share new blog posts from <strong>therike.com</strong> to TikTok + Pinterest via Publer.</p>

    <!-- Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <p class="text-sm text-gray-500">Status</p>
        <p class="text-2xl font-bold mt-1" id="bs-status">Loading...</p>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <p class="text-sm text-gray-500">Total Shared</p>
        <p class="text-2xl font-bold text-green-600 mt-1" id="bs-total-shared">-</p>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <p class="text-sm text-gray-500">TikTok Via</p>
        <p class="text-2xl font-bold text-pink-500 mt-1" id="bs-tiktok-via">-</p>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border">
        <p class="text-sm text-gray-500">Pinterest Via</p>
        <p class="text-2xl font-bold text-red-500 mt-1" id="bs-pinterest-via">-</p>
      </div>
    </div>

    <!-- Controls -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <!-- Config Panel -->
      <div class="bg-dark-900 rounded-xl p-6 border border-dark-700">
        <h3 class="font-semibold text-white mb-4">âš™ï¸ Configuration</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Check Interval (minutes)</label>
            <input id="bs-interval" type="number" value="30" min="5" max="1440" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-4 py-2 text-white text-sm">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Max Articles Per Cycle</label>
            <input id="bs-max-per-cycle" type="number" value="5" min="1" max="20" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-4 py-2 text-white text-sm">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">TikTok Mode</label>
            <select id="bs-tiktok-mode" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-4 py-2 text-white text-sm">
              <option value="broadcast">Broadcast (all accounts)</option>
              <option value="round_robin">Round Robin</option>
              <option value="specific">Specific Account</option>
            </select>
          </div>
          <button onclick="bsSaveConfig()" class="w-full bg-brand-600 hover:bg-brand-700 text-white py-2 px-4 rounded-lg text-sm transition">ğŸ’¾ Save Config</button>
        </div>
      </div>

      <!-- Actions Panel -->
      <div class="bg-dark-900 rounded-xl p-6 border border-dark-700">
        <h3 class="font-semibold text-white mb-4">ğŸ® Actions</h3>
        <div class="space-y-3">
          <div class="flex gap-3">
            <button onclick="bsPause()" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white py-2.5 px-4 rounded-lg text-sm transition">â¸ï¸ Pause</button>
            <button onclick="bsResume()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2.5 px-4 rounded-lg text-sm transition">â–¶ï¸ Resume</button>
          </div>
          <button onclick="bsTick()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2.5 px-4 rounded-lg text-sm transition">ğŸ”„ Run Tick Now</button>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Manual Share (article URL)</label>
            <div class="flex gap-2">
              <input id="bs-manual-url" class="flex-1 bg-dark-800 border border-dark-600 rounded-lg px-4 py-2 text-white text-sm" placeholder="https://therike.com/blogs/sustainable-living/...">
              <button onclick="bsManualShare()" class="bg-brand-600 hover:bg-brand-700 text-white py-2 px-4 rounded-lg text-sm transition">ğŸš€ Share</button>
            </div>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Share Latest from Blog</label>
            <div class="flex gap-2">
              <select id="bs-latest-blog" class="flex-1 bg-dark-800 border border-dark-600 rounded-lg px-4 py-2 text-white text-sm">
                <option value="sustainable-living">sustainable-living</option>
                <option value="brand-partnerships">brand-partnerships</option>
              </select>
              <button onclick="bsShareLatest()" class="bg-pink-600 hover:bg-pink-700 text-white py-2 px-4 rounded-lg text-sm transition">ğŸ“¤ Latest</button>
            </div>
          </div>
          <button onclick="bsClearHistory()" class="w-full bg-red-600/20 hover:bg-red-600/30 text-red-400 py-2 px-4 rounded-lg text-sm transition border border-red-600/30">ğŸ—‘ï¸ Clear History (allows re-share)</button>
        </div>
      </div>
    </div>

    <!-- Watched Blogs -->
    <div class="bg-dark-900 rounded-xl p-6 border border-dark-700 mb-8">
      <h3 class="font-semibold text-white mb-4">ğŸ“š Watched Blogs</h3>
      <div id="bs-blogs" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="bg-dark-800 rounded-lg p-4 border border-dark-600">
          <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸŒ¿</span>
            <div>
              <p class="text-white font-medium">sustainable-living</p>
              <p class="text-xs text-gray-400">therike.com/blogs/sustainable-living</p>
            </div>
          </div>
        </div>
        <div class="bg-dark-800 rounded-lg p-4 border border-dark-600">
          <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸ¤</span>
            <div>
              <p class="text-white font-medium">brand-partnerships</p>
              <p class="text-xs text-gray-400">therike.com/blogs/brand-partnerships</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Share History -->
    <div class="bg-dark-900 rounded-xl p-6 border border-dark-700">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold text-white">ğŸ“‹ Share History</h3>
        <button onclick="loadBlogShareStatus()" class="bg-dark-700 hover:bg-dark-600 text-white py-1.5 px-4 rounded-lg text-sm transition">ğŸ”„ Refresh</button>
      </div>
      <div id="bs-history" class="space-y-2">
        <p class="text-gray-500 text-sm">Loading history...</p>
      </div>
    </div>
  </div>

  <!-- â•â•â• LIVE PREVIEW PAGE â•â•â• -->
  <div class="page {% if page == 'preview' %}active{% endif %}" id="page-preview">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ‘ï¸ Live Post Preview</h2>
    <div class="grid grid-cols-3 gap-6">
      <!-- Input Panel -->
      <div class="col-span-1">
        <div class="bg-white rounded-xl p-5 shadow-sm border sticky top-6">
          <h3 class="font-semibold mb-3">Compose</h3>
          <input id="pv-title" type="text" placeholder="Post title..." class="w-full border rounded-lg px-3 py-2 mb-3 focus:ring-2 focus:ring-brand-500" oninput="updatePreviews()">
          <textarea id="pv-body" rows="8" placeholder="Write your content..." class="w-full border rounded-lg px-3 py-2 mb-3 font-mono text-sm focus:ring-2 focus:ring-brand-500" oninput="updatePreviews()"></textarea>
          <input id="pv-hashtags" placeholder="#hashtag1 #hashtag2 ..." class="w-full border rounded-lg px-3 py-2 mb-3 text-sm" oninput="updatePreviews()">
          <input id="pv-image" type="url" placeholder="Image URL (optional)" class="w-full border rounded-lg px-3 py-2 mb-3 text-sm" oninput="updatePreviews()">
          <div class="text-xs text-gray-400 space-y-1" id="pv-char-stats"></div>
        </div>
      </div>

      <!-- Preview Cards -->
      <div class="col-span-2 space-y-6">
        <!-- Twitter Preview -->
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div class="px-5 py-3 bg-sky-50 border-b flex items-center gap-2">
            <span class="text-lg">ğŸ¦</span>
            <span class="font-semibold text-sky-700">Twitter / X</span>
            <span class="ml-auto text-xs px-2 py-0.5 rounded-full" id="pv-tw-limit">0 / 280</span>
          </div>
          <div class="p-5">
            <div class="flex gap-3">
              <div class="w-10 h-10 rounded-full bg-brand-200 flex-shrink-0 flex items-center justify-center text-sm font-bold text-brand-700">V</div>
              <div class="flex-1">
                <div class="flex items-center gap-2"><span class="font-bold text-sm">ViralOps</span><span class="text-xs text-gray-400">@viralops Â· now</span></div>
                <p class="text-sm mt-1 whitespace-pre-wrap" id="pv-tw-text"></p>
                <div id="pv-tw-img" class="mt-3 rounded-2xl overflow-hidden hidden"><img class="w-full max-h-72 object-cover"></div>
                <p class="text-xs text-blue-500 mt-2" id="pv-tw-tags"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Instagram Preview -->
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div class="px-5 py-3 bg-pink-50 border-b flex items-center gap-2">
            <span class="text-lg">ğŸ“·</span>
            <span class="font-semibold text-pink-700">Instagram</span>
            <span class="ml-auto text-xs px-2 py-0.5 rounded-full" id="pv-ig-limit">0 / 2200</span>
          </div>
          <div class="p-5">
            <div class="flex items-center gap-2 mb-3"><div class="w-8 h-8 rounded-full bg-gradient-to-tr from-amber-400 via-pink-500 to-purple-600 flex items-center justify-center text-xs font-bold text-white">V</div><span class="font-semibold text-sm">viralops_engine</span></div>
            <div id="pv-ig-img" class="bg-gray-100 rounded-lg mb-3 hidden"><img class="w-full max-h-80 object-cover rounded-lg"></div>
            <p class="text-sm whitespace-pre-wrap" id="pv-ig-text"><span class="font-semibold">viralops_engine</span> <span id="pv-ig-caption"></span></p>
            <p class="text-xs text-blue-500 mt-2" id="pv-ig-tags"></p>
          </div>
        </div>

        <!-- LinkedIn Preview -->
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div class="px-5 py-3 bg-blue-50 border-b flex items-center gap-2">
            <span class="text-lg">ğŸ’¼</span>
            <span class="font-semibold text-blue-700">LinkedIn</span>
            <span class="ml-auto text-xs px-2 py-0.5 rounded-full" id="pv-li-limit">0 / 3000</span>
          </div>
          <div class="p-5">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-12 h-12 rounded-full bg-blue-200 flex items-center justify-center font-bold text-blue-700">V</div>
              <div><p class="font-semibold text-sm">ViralOps Engine</p><p class="text-xs text-gray-400">Content Automation Â· 1st</p></div>
            </div>
            <p class="text-sm whitespace-pre-wrap" id="pv-li-text"></p>
            <div id="pv-li-img" class="mt-3 rounded-lg overflow-hidden hidden"><img class="w-full max-h-72 object-cover"></div>
            <p class="text-xs text-blue-600 mt-2" id="pv-li-tags"></p>
          </div>
        </div>

        <!-- Facebook Preview -->
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div class="px-5 py-3 bg-indigo-50 border-b flex items-center gap-2">
            <span class="text-lg">ğŸ“˜</span>
            <span class="font-semibold text-indigo-700">Facebook</span>
            <span class="ml-auto text-xs px-2 py-0.5 rounded-full" id="pv-fb-limit">0 / 63206</span>
          </div>
          <div class="p-5">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center font-bold text-indigo-700 text-sm">V</div>
              <div><p class="font-semibold text-sm">ViralOps Engine</p><p class="text-xs text-gray-400">Just now Â· ğŸŒ</p></div>
            </div>
            <p class="text-sm whitespace-pre-wrap" id="pv-fb-text"></p>
            <div id="pv-fb-img" class="mt-3 rounded-lg overflow-hidden hidden"><img class="w-full max-h-72 object-cover"></div>
            <p class="text-xs text-blue-600 mt-2" id="pv-fb-tags"></p>
          </div>
        </div>

        <!-- TikTok Preview -->
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div class="px-5 py-3 bg-gray-900 border-b flex items-center gap-2">
            <span class="text-lg">ğŸµ</span>
            <span class="font-semibold text-white">TikTok</span>
            <span class="ml-auto text-xs px-2 py-0.5 rounded-full text-gray-300" id="pv-tt-limit">0 / 2200</span>
          </div>
          <div class="p-5 bg-gray-50">
            <div class="flex items-center gap-2 mb-3"><div class="w-8 h-8 rounded-full bg-gradient-to-r from-pink-500 to-cyan-400 flex items-center justify-center text-xs font-bold text-white">V</div><span class="font-semibold text-sm">@viralops</span></div>
            <p class="text-sm whitespace-pre-wrap" id="pv-tt-text"></p>
            <p class="text-xs mt-2" id="pv-tt-tags"></p>
          </div>
        </div>

        <!-- Reddit Preview -->
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div class="px-5 py-3 bg-orange-50 border-b flex items-center gap-2">
            <span class="text-lg">ğŸ”´</span>
            <span class="font-semibold text-orange-700">Reddit</span>
            <span class="ml-auto text-xs px-2 py-0.5 rounded-full" id="pv-rd-limit">0 / 40000</span>
          </div>
          <div class="p-5">
            <p class="text-xs text-gray-400 mb-1">r/yoursubreddit Â· Posted by u/viralops</p>
            <h3 class="font-bold text-base mb-2" id="pv-rd-title"></h3>
            <p class="text-sm whitespace-pre-wrap text-gray-700" id="pv-rd-text"></p>
            <div id="pv-rd-img" class="mt-3 rounded-lg overflow-hidden hidden"><img class="w-full max-h-72 object-cover"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- â•â•â• JAVASCRIPT â•â•â• -->
<script>
// â”€â”€ State â”€â”€
let selectedPlatforms = [];
let selectedHashtags = [];
let calYear, calMonth;
const now = new Date();
calYear = now.getFullYear();
calMonth = now.getMonth();

// â”€â”€ Toast â”€â”€
function toast(msg, type='info') {
  const colors = {info:'bg-blue-500',success:'bg-green-500',error:'bg-red-500',warning:'bg-amber-500'};
  const el = document.createElement('div');
  el.className = `toast text-white text-sm px-4 py-2 rounded-lg shadow-lg ${colors[type]||colors.info}`;
  el.textContent = msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// â”€â”€ Platform Chips (dynamic 16) â”€â”€
const PLAT_CHIP_COLORS = {
  twitter:'sky', instagram:'pink', facebook:'indigo', youtube:'red', linkedin:'blue',
  tiktok:'gray', pinterest:'rose', reddit:'orange', medium:'green', tumblr:'blue',
  threads:'gray', bluesky:'cyan', mastodon:'violet', quora:'red', shopify_blog:'emerald', lemon8:'lime'
};

const PLAT_EXTRA_FIELDS = {
  reddit: [{id:'reddit-subreddit',ph:'Subreddit (e.g., plantbaseddiet)'},{id:'reddit-flair',ph:'Flair ID (optional)'}],
  medium: [{id:'medium-tags',ph:'Tags (comma-separated)'},{id:'medium-publication',ph:'Publication ID (optional)'}],
  tumblr: [{id:'tumblr-blogname',ph:'Blog name'},{id:'tumblr-tags',ph:'Tags (comma-separated)'}],
  shopify_blog: [{id:'shopify-blog-id',ph:'Blog ID'},{id:'shopify-tags',ph:'Tags (comma-separated)'}],
  twitter: [{id:'twitter-thread',ph:'Thread mode? (yes/no)'}],
  instagram: [{id:'instagram-location',ph:'Location tag (optional)'}],
  linkedin: [{id:'linkedin-visibility',ph:'Visibility: public / connections'}],
  facebook: [{id:'facebook-page-id',ph:'Page ID (optional)'}],
  tiktok: [{id:'tiktok-sounds',ph:'Sound/music ID (optional)'}],
  pinterest: [{id:'pinterest-board',ph:'Board name'},{id:'pinterest-link',ph:'Destination URL'}],
  threads: [{id:'threads-reply',ph:'Reply to thread ID (optional)'}],
  bluesky: [{id:'bluesky-langs',ph:'Languages (e.g., en)'}],
  mastodon: [{id:'mastodon-visibility',ph:'Visibility: public / unlisted / private'}],
  quora: [{id:'quora-space',ph:'Space name (optional)'}],
  lemon8: [{id:'lemon8-tags',ph:'Tags (comma-separated)'}],
};

async function loadComposeChips() {
  try {
    const r = await fetch('/api/platforms/setup-status');
    const d = await r.json();
    const chipsEl = document.getElementById('platform-chips');
    if (!chipsEl) return;
    chipsEl.innerHTML = Object.entries(d.platforms).map(([name, info]) => {
      const icon = PLAT_ICONS[name] || 'ğŸ”—';
      const col = PLAT_CHIP_COLORS[name] || 'gray';
      const configured = info.configured;
      return `<button type="button" onclick="toggleChip(this,'${name}')" class="chip px-3 py-1.5 rounded-full text-sm border-2 border-${col}-300 text-${col}-700 hover:bg-${col}-50 ${!configured?'opacity-40':''}" title="${configured?'Ready':'Not configured â€” set env keys first'}" data-platform="${name}" data-configured="${configured}">${icon} ${name.replace('_',' ')}</button>`;
    }).join('');
  } catch(e) { console.error('loadComposeChips error', e); }
}

function toggleChip(btn, platform) {
  const idx = selectedPlatforms.indexOf(platform);
  if (idx >= 0) { selectedPlatforms.splice(idx,1); btn.classList.remove('bg-brand-100','border-brand-500','font-bold'); }
  else { selectedPlatforms.push(platform); btn.classList.add('bg-brand-100','border-brand-500','font-bold'); }
  document.getElementById('compose-plat-count').textContent = `(${selectedPlatforms.length} selected)`;
  renderExtraFields();
  renderComposeLimits();
}

function selectAllPlatforms() {
  document.querySelectorAll('#platform-chips .chip[data-configured="true"]').forEach(btn => {
    const p = btn.dataset.platform;
    if (!selectedPlatforms.includes(p)) { selectedPlatforms.push(p); btn.classList.add('bg-brand-100','border-brand-500','font-bold'); }
  });
  document.getElementById('compose-plat-count').textContent = `(${selectedPlatforms.length} selected)`;
  renderExtraFields();
  renderComposeLimits();
}

function clearAllPlatforms() {
  selectedPlatforms = [];
  document.querySelectorAll('#platform-chips .chip').forEach(btn => btn.classList.remove('bg-brand-100','border-brand-500','font-bold'));
  document.getElementById('compose-plat-count').textContent = '(0 selected)';
  renderExtraFields();
  renderComposeLimits();
}

function renderExtraFields() {
  const container = document.getElementById('extra-fields');
  if (!container) return;
  container.innerHTML = selectedPlatforms.filter(p => PLAT_EXTRA_FIELDS[p]).map(p => {
    const icon = PLAT_ICONS[p] || 'ğŸ”—';
    const col = PLAT_CHIP_COLORS[p] || 'gray';
    const fields = PLAT_EXTRA_FIELDS[p];
    return `<div class="bg-${col}-50 rounded-lg p-4">
      <h4 class="font-medium text-${col}-800 mb-2">${icon} ${p.replace('_',' ')} Settings</h4>
      ${fields.map(f => `<input id="${f.id}" placeholder="${f.ph}" class="w-full border rounded px-3 py-2 mb-2">`).join('')}
    </div>`;
  }).join('');
}

function renderComposeLimits() {
  const container = document.getElementById('compose-limits');
  const badges = document.getElementById('compose-limit-badges');
  if (!container || !badges) return;
  if (selectedPlatforms.length === 0) { container.classList.add('hidden'); return; }
  container.classList.remove('hidden');
  const body = document.getElementById('post-body')?.value || '';
  const title = document.getElementById('post-title')?.value || '';
  const len = title.length + body.length;
  badges.innerHTML = selectedPlatforms.map(p => {
    const limit = PLATFORM_LIMITS[p] || 10000;
    const pct = Math.round(len / limit * 100);
    const color = pct > 100 ? 'bg-red-100 text-red-700' : pct > 80 ? 'bg-amber-100 text-amber-700' : 'bg-green-100 text-green-700';
    return `<span class="px-2 py-0.5 rounded-full ${color}">${PLAT_ICONS[p]||'ğŸ”—'} ${p}: ${len}/${limit}</span>`;
  }).join('');
}

// â”€â”€ Character count â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  const body = document.getElementById('post-body');
  if(body) body.addEventListener('input', () => {
    document.getElementById('char-count').textContent = body.value.length + ' characters';
    document.getElementById('word-count').textContent = (body.value.trim().split(/\s+/).filter(Boolean).length) + ' words';
  });
  // Auto-load page data
  const page = document.querySelector('.page.active');
  if(page) {
    if(page.id==='page-dashboard') loadDashboard();
    else if(page.id==='page-content') filterPosts('all');
    else if(page.id==='page-calendar') renderCalendar();
    else if(page.id==='page-analytics') loadAnalytics();
    else if(page.id==='page-rss') loadRSSFeeds();
    else if(page.id==='page-hashtags') loadHashtagCollections();
    else if(page.id==='page-compose') { loadComposeChips(); loadHashtagSelector(); }
    else if(page.id==='page-platforms') loadPlatforms();
    else if(page.id==='page-engagement') loadEngagement();
    else if(page.id==='page-timeslots') loadBestHours();
    else if(page.id==='page-preview') updatePreviews();
    else if(page.id==='page-autopilot') loadAutoPilotPlatforms();
    else if(page.id==='page-publer') loadPublerStatus();
    else if(page.id==='page-blog-share') loadBlogShareStatus();
  }
  // Always load sidebar channels
  loadSidebarChannels();
});

// â”€â”€ Dashboard â”€â”€
async function loadDashboard() {
  try {
    const stats = await fetch('/api/stats').then(r=>r.json());
    document.getElementById('stat-total').textContent = stats.total;
    document.getElementById('stat-published').textContent = stats.published;
    document.getElementById('stat-scheduled').textContent = stats.scheduled;
    document.getElementById('stat-drafts').textContent = stats.drafts;

    const posts = await fetch('/api/posts').then(r=>r.json());
    const recent = posts.slice(0,5);
    const el = document.getElementById('recent-posts');
    if(recent.length===0) { el.innerHTML='<p class="text-gray-400 text-sm">No posts yet. Create your first post!</p>'; return; }
    el.innerHTML = recent.map(p => `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
      <div><p class="text-sm font-medium">${p.title||'Untitled'}</p><p class="text-xs text-gray-400">${p.category} Â· ${p.status}</p></div>
      <span class="text-xs px-2 py-1 rounded-full ${p.status==='published'?'bg-green-100 text-green-700':p.status==='scheduled'?'bg-blue-100 text-blue-700':p.status==='failed'?'bg-red-100 text-red-700':'bg-gray-100 text-gray-600'}">${p.status}</span>
    </div>`).join('');

    // Budget
    try {
      const budget = await fetch('/api/budget').then(r=>r.json());
      document.getElementById('budget-info').innerHTML = budget.error ? `<span class="text-red-500">${budget.error}</span>` :
        `<div>Daily: $${budget.spent_today} / $${budget.daily_limit} (${budget.daily_pct}%)</div>
         <div>Monthly: $${budget.spent_this_month} / $${budget.monthly_limit} (${budget.monthly_pct}%)</div>
         <div class="mt-1">Model: <strong>${budget.recommended_model}</strong></div>`;
    } catch(e) {}
  } catch(e) { toast('Failed to load dashboard', 'error'); }
}

// â”€â”€ Test Connection â”€â”€
async function testConn(platform) {
  toast(`Testing ${platform}...`);
  try {
    const r = await fetch(`/api/test-connection/${platform}`, {method:'POST'}).then(r=>r.json());
    toast(r.connected ? `${platform} connected!` : `${platform} failed: ${r.error||'not configured'}`, r.connected?'success':'error');
  } catch(e) { toast(`Error testing ${platform}`, 'error'); }
}

// â”€â”€ Scheduler â”€â”€
async function triggerScheduler() {
  toast('Running scheduler...');
  try {
    const r = await fetch('/api/scheduler/run-now', {method:'POST'}).then(r=>r.json());
    toast(`Scheduler: ${r.results?.length||0} posts processed`, 'success');
  } catch(e) { toast('Scheduler error', 'error'); }
}

// â”€â”€ Save Post â”€â”€
function gatherExtra() {
  const extra = {};
  // Dynamically gather from all platform field definitions
  selectedPlatforms.forEach(p => {
    const fields = PLAT_EXTRA_FIELDS[p];
    if (!fields) return;
    const platExtra = {};
    fields.forEach(f => {
      const val = document.getElementById(f.id)?.value || '';
      const key = f.id.replace(p + '-', '').replace(/-/g, '_');
      if (f.ph.includes('comma-separated') && val) platExtra[key] = val.split(',').map(t => t.trim()).filter(Boolean);
      else platExtra[key] = val;
    });
    extra[p] = platExtra;
  });
  if (selectedHashtags.length) extra.hashtags = selectedHashtags;
  return extra;
}

async function savePost(status) {
  const data = {
    title: document.getElementById('post-title').value,
    body: document.getElementById('post-body').value,
    category: document.getElementById('post-category').value,
    platforms: selectedPlatforms,
    status: status,
    scheduled_at: document.getElementById('post-schedule')?.value || '',
    extra_fields: gatherExtra(),
  };
  if(!data.title && !data.body) { toast('Please enter title or body', 'warning'); return; }
  try {
    const r = await fetch('/api/posts', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}).then(r=>r.json());
    toast(r.success ? `Post saved as ${status}!` : 'Save failed', r.success?'success':'error');
    if(r.success) { document.getElementById('post-title').value=''; document.getElementById('post-body').value=''; }
  } catch(e) { toast('Save error', 'error'); }
}

async function publishNow() {
  const data = {
    title: document.getElementById('post-title').value,
    body: document.getElementById('post-body').value,
    category: document.getElementById('post-category').value,
    platforms: selectedPlatforms,
    status: 'draft',
    extra_fields: gatherExtra(),
  };
  if(!data.title && !data.body) { toast('Please enter content', 'warning'); return; }
  if(selectedPlatforms.length===0) { toast('Select at least one platform', 'warning'); return; }
  try {
    const save = await fetch('/api/posts', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}).then(r=>r.json());
    if(!save.success) { toast('Save failed', 'error'); return; }
    toast('Publishing...');
    const pub = await fetch(`/api/publish/${save.post_id}`, {method:'POST'}).then(r=>r.json());
    pub.results.forEach(r => toast(`${r.platform}: ${r.success?'âœ… Published':'âŒ '+r.error}`, r.success?'success':'error'));
  } catch(e) { toast('Publish error', 'error'); }
}

// â”€â”€ Content Library â”€â”€
let bulkSelected = new Set();

async function filterPosts(status) {
  bulkSelected.clear();
  updateBulkBar();
  try {
    const posts = await fetch(`/api/posts?status=${status}`).then(r=>r.json());
    const el = document.getElementById('content-table');
    const totalEl = document.getElementById('content-total');
    if (totalEl) totalEl.textContent = `${posts.length} posts`;
    if(posts.length===0) { el.innerHTML='<tr><td colspan="7" class="px-4 py-8 text-center text-gray-400">No posts found</td></tr>'; return; }
    el.innerHTML = posts.map(p => {
      let platforms = [];
      try { platforms = JSON.parse(p.platforms||'[]'); } catch(e) {}
      const statusColors = {draft:'bg-gray-100 text-gray-700',scheduled:'bg-blue-100 text-blue-700',published:'bg-green-100 text-green-700',failed:'bg-red-100 text-red-700'};
      return `<tr class="border-t hover:bg-gray-50">
        <td class="px-3 py-3 text-center"><input type="checkbox" class="post-checkbox" value="${p.id}" onchange="toggleBulk(${p.id})"></td>
        <td class="px-4 py-3"><p class="text-sm font-medium">${p.title||'Untitled'}</p><p class="text-xs text-gray-400">${(p.body||'').substring(0,80)}...</p></td>
        <td class="px-4 py-3 text-sm">${p.category||'-'}</td>
        <td class="px-4 py-3"><div class="flex flex-wrap gap-1">${platforms.map(pl=>`<span class="text-xs px-1.5 py-0.5 bg-brand-100 text-brand-700 rounded">${PLAT_ICONS[pl]||''} ${pl}</span>`).join('')}</div></td>
        <td class="px-4 py-3"><span class="text-xs px-2 py-1 rounded-full ${statusColors[p.status]||''}">${p.status}</span></td>
        <td class="px-4 py-3 text-xs text-gray-400">${p.scheduled_at||p.published_at||'-'}</td>
        <td class="px-4 py-3"><div class="flex gap-1">
          ${p.status==='draft'?`<button onclick="publishPostById(${p.id})" class="text-xs bg-brand-500 text-white px-2 py-1 rounded">Publish</button>`:''}
          <button onclick="deletePost(${p.id})" class="text-xs bg-red-500 text-white px-2 py-1 rounded">Delete</button>
        </div></td>
      </tr>`;
    }).join('');
  } catch(e) { toast('Load error', 'error'); }
}

// â”€â”€ Bulk Actions â”€â”€
function toggleBulk(id) { bulkSelected.has(id) ? bulkSelected.delete(id) : bulkSelected.add(id); updateBulkBar(); }
function toggleSelectAll(cb) {
  document.querySelectorAll('.post-checkbox').forEach(c => { c.checked = cb.checked; const id = parseInt(c.value); cb.checked ? bulkSelected.add(id) : bulkSelected.delete(id); });
  updateBulkBar();
}
function updateBulkBar() {
  const bar = document.getElementById('bulk-bar');
  const count = document.getElementById('bulk-count');
  if (!bar) return;
  if (bulkSelected.size > 0) { bar.classList.remove('hidden'); count.textContent = `${bulkSelected.size} selected`; }
  else { bar.classList.add('hidden'); }
}
function clearBulk() { bulkSelected.clear(); document.querySelectorAll('.post-checkbox').forEach(c => c.checked = false); document.getElementById('select-all-posts').checked = false; updateBulkBar(); }

async function bulkPublish() {
  if (!confirm(`Publish ${bulkSelected.size} posts?`)) return;
  toast(`Publishing ${bulkSelected.size} posts...`);
  let ok = 0, fail = 0;
  for (const id of bulkSelected) {
    try { const r = await fetch(`/api/publish/${id}`, {method:'POST'}).then(r=>r.json()); r.success ? ok++ : fail++; }
    catch(e) { fail++; }
  }
  toast(`Published: ${ok} âœ…, Failed: ${fail} âŒ`, ok > 0 ? 'success' : 'error');
  clearBulk(); filterPosts('all');
}

async function bulkDelete() {
  if (!confirm(`Delete ${bulkSelected.size} posts permanently?`)) return;
  for (const id of bulkSelected) { await fetch(`/api/posts/${id}`, {method:'DELETE'}); }
  toast(`Deleted ${bulkSelected.size} posts`, 'success');
  clearBulk(); filterPosts('all');
}

async function bulkSchedule() {
  const dt = prompt('Schedule all selected posts at (YYYY-MM-DDTHH:MM):', new Date(Date.now() + 3600000).toISOString().slice(0, 16));
  if (!dt) return;
  toast('Scheduling...');
  for (const id of bulkSelected) {
    await fetch(`/api/posts/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({status: 'scheduled', scheduled_at: dt}) }).catch(() => {});
  }
  toast(`Scheduled ${bulkSelected.size} posts`, 'success');
  clearBulk(); filterPosts('all');
}

async function deletePost(id) { if(!confirm('Delete this post?')) return; await fetch(`/api/posts/${id}`,{method:'DELETE'}); filterPosts('all'); toast('Deleted','success'); }
async function publishPostById(id) { toast('Publishing...'); const r=await fetch(`/api/publish/${id}`,{method:'POST'}).then(r=>r.json()); toast(r.success?'Published!':'Failed','success'); filterPosts('all'); }

// â”€â”€ Calendar â”€â”€
function calNav(d) { calMonth+=d; if(calMonth>11){calMonth=0;calYear++;} if(calMonth<0){calMonth=11;calYear--;} renderCalendar(); }
async function renderCalendar() {
  document.getElementById('cal-month').textContent = new Date(calYear,calMonth).toLocaleDateString('en',{month:'long',year:'numeric'});
  const events = await fetch('/api/calendar-events').then(r=>r.json()).catch(()=>[]);
  const firstDay = new Date(calYear,calMonth,1).getDay();
  const daysInMonth = new Date(calYear,calMonth+1,0).getDate();
  const today = new Date().toISOString().slice(0,10);
  let html = '';
  for(let i=0;i<firstDay;i++) html+='<div class="p-2 h-24"></div>';
  for(let d=1;d<=daysInMonth;d++) {
    const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayEvents = events.filter(e=>e.date===dateStr);
    const isToday = dateStr===today;
    html+=`<div class="p-2 h-24 border rounded-lg ${isToday?'ring-2 ring-brand-500':'hover:bg-gray-50'}">
      <span class="text-xs font-medium ${isToday?'text-brand-600':'text-gray-700'}">${d}</span>
      ${dayEvents.map(e=>`<div class="text-xs mt-1 px-1 py-0.5 rounded ${e.status==='published'?'bg-green-100 text-green-700':'bg-blue-100 text-blue-700'} truncate">${e.title||'Post'}</div>`).join('')}
    </div>`;
  }
  document.getElementById('cal-grid').innerHTML = html;
}

// â”€â”€ RSS Feeds â”€â”€
async function loadRSSFeeds() {
  try {
    const feeds = await fetch('/api/rss/feeds').then(r=>r.json());
    const el = document.getElementById('rss-feeds-list');
    if(feeds.length===0) { el.innerHTML='<p class="text-gray-400 text-sm">No feeds configured. Add one above!</p>'; return; }
    el.innerHTML = feeds.map(f => `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
      <div>
        <p class="text-sm font-medium">${f.name||f.url}</p>
        <p class="text-xs text-gray-400">${f.url} Â· ${f.import_mode} Â· ${f.last_fetched?'Last: '+f.last_fetched.slice(0,16):'Never fetched'}</p>
      </div>
      <div class="flex gap-2">
        <button onclick="fetchFeed('${f.id}')" class="text-xs bg-brand-500 text-white px-3 py-1 rounded-full">Fetch</button>
        <button onclick="removeFeed('${f.id}')" class="text-xs bg-red-500 text-white px-3 py-1 rounded-full">Remove</button>
      </div>
    </div>`).join('');
  } catch(e) { toast('Failed to load feeds', 'error'); }
}

async function addFeed() {
  const url = document.getElementById('rss-url').value;
  const name = document.getElementById('rss-name').value;
  const mode = document.getElementById('rss-mode').value;
  if(!url) { toast('Enter a feed URL', 'warning'); return; }
  try {
    const r = await fetch('/api/rss/feeds', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url,name,import_mode:mode})}).then(r=>r.json());
    if(r.error) { toast(r.error, 'error'); return; }
    toast('Feed added!', 'success');
    document.getElementById('rss-url').value='';
    document.getElementById('rss-name').value='';
    loadRSSFeeds();
  } catch(e) { toast('Error adding feed', 'error'); }
}

async function previewFeed() {
  const url = document.getElementById('rss-url').value;
  if(!url) { toast('Enter a URL first', 'warning'); return; }
  toast('Fetching preview...');
  try {
    const r = await fetch('/api/rss/preview', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url})}).then(r=>r.json());
    if(r.error) { toast(r.error, 'error'); return; }
    const el = document.getElementById('rss-preview');
    el.classList.remove('hidden');
    document.getElementById('rss-preview-content').innerHTML = `
      <p class="text-sm font-medium mb-2">${r.feed_title||'Unknown feed'} (${r.entry_count} entries)</p>
      ${r.entries.slice(0,3).map(e=>`<div class="p-3 bg-gray-50 rounded-lg mb-2">
        <p class="text-sm font-medium">${e.title}</p>
        <p class="text-xs text-gray-500 mt-1">${e.excerpt?.substring(0,200)||''}...</p>
        <p class="text-xs text-gray-400 mt-1">${e.published||''} Â· <a href="${e.url}" target="_blank" class="text-brand-500">Link</a></p>
      </div>`).join('')}`;
  } catch(e) { toast('Preview error', 'error'); }
}

async function fetchFeed(feedId) {
  toast('Fetching feed...');
  try {
    const r = await fetch(`/api/rss/fetch/${feedId}`, {method:'POST'}).then(r=>r.json());
    if(r.error) { toast(r.error, 'error'); return; }
    toast(`Fetched ${r.entry_count} entries`, 'success');
    const el = document.getElementById('rss-entries');
    el.innerHTML = r.entries.map(e=>`<div class="p-3 bg-gray-50 rounded-lg flex justify-between items-start">
      <div class="flex-1 mr-4">
        <p class="text-sm font-medium">${e.title}</p>
        <p class="text-xs text-gray-500 mt-1">${e.excerpt?.substring(0,200)||''}...</p>
        <p class="text-xs text-gray-400 mt-1">${e.published||''} Â· ${e.tags?.join(', ')||'no tags'}</p>
      </div>
      <button onclick='importRSSEntry(${JSON.stringify(e).replace(/'/g,"&#39;")})' class="text-xs bg-brand-500 text-white px-3 py-1.5 rounded-full whitespace-nowrap">Import as Draft</button>
    </div>`).join('');
    loadRSSFeeds();
  } catch(e) { toast('Fetch error', 'error'); }
}

async function removeFeed(feedId) {
  if(!confirm('Remove this feed?')) return;
  await fetch(`/api/rss/feeds/${feedId}`, {method:'DELETE'});
  toast('Feed removed', 'success');
  loadRSSFeeds();
}

async function importRSSEntry(entry) {
  try {
    const r = await fetch('/api/rss/import', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({entry, platforms:['medium','shopify_blog']})}).then(r=>r.json());
    toast(r.success ? `Imported as draft #${r.post_id}` : 'Import failed', r.success?'success':'error');
  } catch(e) { toast('Import error', 'error'); }
}

// â”€â”€ Hashtag Collections â”€â”€
async function loadHashtagCollections() {
  try {
    const collections = await fetch('/api/hashtags').then(r=>r.json());
    const el = document.getElementById('hashtag-collections');
    if(collections.length===0) { el.innerHTML='<p class="text-gray-400 text-sm">No collections yet. Create one above!</p>'; return; }
    el.innerHTML = collections.map(c => {
      let tags = [];
      try { tags = JSON.parse(c.hashtags||'[]'); } catch(e) {}
      return `<div class="p-4 bg-gray-50 rounded-lg">
        <div class="flex justify-between items-center mb-2">
          <div>
            <p class="text-sm font-medium">${c.name}</p>
            <p class="text-xs text-gray-400">${c.niche} Â· ${tags.length} tags Â· ${c.updated_at?.slice(0,16)||''}</p>
          </div>
          <div class="flex gap-2">
            <button onclick="copyHashtags(${c.id})" class="text-xs bg-purple-500 text-white px-3 py-1 rounded-full">Copy</button>
            <button onclick="deleteHashtagCollection(${c.id})" class="text-xs bg-red-500 text-white px-3 py-1 rounded-full">Delete</button>
          </div>
        </div>
        <div class="flex flex-wrap gap-1">${tags.slice(0,20).map(t=>`<span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">${t}</span>`).join('')}${tags.length>20?`<span class="text-xs text-gray-400">+${tags.length-20} more</span>`:''}</div>
      </div>`;
    }).join('');
  } catch(e) { toast('Failed to load collections', 'error'); }
}

async function saveHashtagCollection() {
  const name = document.getElementById('htag-name').value;
  const niche = document.getElementById('htag-niche').value || 'general';
  const tagsRaw = document.getElementById('htag-tags').value;
  const tags = tagsRaw.split(/[,\n]/).map(t=>t.trim()).filter(Boolean).map(t=>t.startsWith('#')?t:'#'+t);
  if(!name) { toast('Enter a collection name', 'warning'); return; }
  if(tags.length===0) { toast('Add some hashtags', 'warning'); return; }
  try {
    const r = await fetch('/api/hashtags', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name,niche,hashtags:tags})}).then(r=>r.json());
    toast(r.success?'Collection saved!':'Save failed', r.success?'success':'error');
    if(r.success) { document.getElementById('htag-name').value=''; document.getElementById('htag-tags').value=''; loadHashtagCollections(); }
  } catch(e) { toast('Save error', 'error'); }
}

async function generateHashtagCollection() {
  const niche = document.getElementById('htag-niche').value || 'general';
  toast('Generating hashtags...');
  try {
    const r = await fetch('/api/hashtags/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({niche,platform:'instagram'})}).then(r=>r.json());
    if(r.success) {
      const tags = r.hashtags.combined || [];
      document.getElementById('htag-tags').value = tags.join('\n');
      toast(`Generated ${tags.length} hashtags`, 'success');
    } else { toast(r.error||'Generation failed', 'error'); }
  } catch(e) { toast('Generation error', 'error'); }
}

async function deleteHashtagCollection(id) {
  if(!confirm('Delete this collection?')) return;
  await fetch(`/api/hashtags/${id}`, {method:'DELETE'});
  toast('Deleted', 'success');
  loadHashtagCollections();
}

function copyHashtags(id) {
  fetch('/api/hashtags').then(r=>r.json()).then(cols => {
    const col = cols.find(c=>c.id===id);
    if(col) {
      let tags = [];
      try { tags = JSON.parse(col.hashtags||'[]'); } catch(e) {}
      navigator.clipboard.writeText(tags.join(' '));
      toast('Copied to clipboard!', 'success');
    }
  });
}

// â”€â”€ Hashtag Selector (in Compose) â”€â”€
async function loadHashtagSelector() {
  try {
    const cols = await fetch('/api/hashtags').then(r=>r.json());
    const el = document.getElementById('hashtag-selector');
    if(!el) return;
    if(cols.length===0) { el.innerHTML='<span class="text-xs text-gray-400">No collections yet â€” go to Hashtags page to create</span>'; return; }
    el.innerHTML = cols.map(c => `<button onclick="applyHashtagCollection(${c.id})" class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-200">${c.name}</button>`).join('');
  } catch(e) {}
}

async function applyHashtagCollection(id) {
  const cols = await fetch('/api/hashtags').then(r=>r.json());
  const col = cols.find(c=>c.id===id);
  if(col) {
    let tags = [];
    try { tags = JSON.parse(col.hashtags||'[]'); } catch(e) {}
    selectedHashtags = [...new Set([...selectedHashtags, ...tags])];
    document.getElementById('selected-hashtags').textContent = selectedHashtags.join(' ');
    toast(`Applied ${tags.length} hashtags`, 'success');
  }
}

async function generateHashtags() {
  toast('Generating...');
  try {
    const r = await fetch('/api/hashtags/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({niche:'general',platform:'instagram'})}).then(r=>r.json());
    if(r.success) {
      selectedHashtags = [...new Set([...selectedHashtags, ...(r.hashtags.combined||[])])];
      document.getElementById('selected-hashtags').textContent = selectedHashtags.join(' ');
      toast(`Added ${r.hashtags.combined?.length||0} hashtags`, 'success');
    }
  } catch(e) { toast('Error', 'error'); }
}

function addCustomHashtag() {
  const input = document.getElementById('custom-hashtag');
  let tag = input.value.trim();
  if(!tag) return;
  if(!tag.startsWith('#')) tag = '#' + tag;
  if(!selectedHashtags.includes(tag)) selectedHashtags.push(tag);
  document.getElementById('selected-hashtags').textContent = selectedHashtags.join(' ');
  input.value = '';
}

// â”€â”€ Analytics â”€â”€
async function loadAnalytics() {
  try {
    const data = await fetch('/api/analytics').then(r=>r.json());
    const logs = data.logs || [];
    const stats = data.platform_stats || {};

    const total = logs.length;
    const success = logs.filter(l=>l.success).length;
    const failed = total - success;
    const rate = total>0 ? Math.round(success/total*100) : 0;

    document.getElementById('a-total').textContent = total;
    document.getElementById('a-success').textContent = success;
    document.getElementById('a-failed').textContent = failed;
    document.getElementById('a-rate').textContent = rate + '%';
    document.getElementById('a-platforms').textContent = Object.keys(stats).length;

    // Chart.js visualizations
    buildTrendChart(logs);
    buildPlatformChart(stats);
    buildHoursChart(logs);
    renderTopPosts(logs);

    // Platform bars
    const barsEl = document.getElementById('platform-bars');
    const platformColors = {reddit:'bg-orange-500',medium:'bg-green-500',tumblr:'bg-blue-500',shopify_blog:'bg-emerald-500'};
    barsEl.innerHTML = Object.entries(stats).map(([p,s]) => {
      const pct = s.total>0 ? Math.round(s.success/s.total*100) : 0;
      return `<div class="mb-3"><div class="flex justify-between text-sm mb-1"><span>${PLAT_ICONS[p]||'ğŸ”—'} ${p}</span><span>${pct}% (${s.success}/${s.total})</span></div>
        <div class="w-full bg-gray-200 rounded-full h-2"><div class="${platformColors[p]||'bg-brand-500'} h-2 rounded-full" style="width:${pct}%"></div></div></div>`;
    }).join('') || '<p class="text-gray-400 text-sm">No data yet</p>';

    // Log table
    const logEl = document.getElementById('publish-log');
    logEl.innerHTML = logs.slice(0,20).map(l => `<div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
      <span>${PLAT_ICONS[l.platform]||'ğŸ”—'} ${l.platform}</span>
      <span class="${l.success?'text-green-600':'text-red-600'}">${l.success?'âœ…':'âŒ'} ${l.post_url?`<a href="${l.post_url}" target="_blank" class="text-brand-500">Link</a>`:l.error||'Failed'}</span>
      <span class="text-gray-400">${l.published_at?.slice(0,16)||''}</span>
    </div>`).join('') || '<p class="text-gray-400 text-sm">No publish history</p>';
  } catch(e) { toast('Analytics error', 'error'); }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-PILOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let apSelectedPlatforms = [];
let apGeneratedData = null;

async function loadAutoPilotPlatforms() {
  try {
    const r = await fetch('/api/platforms/setup-status');
    const d = await r.json();
    const el = document.getElementById('ap-platforms');
    if (!el) return;
    el.innerHTML = Object.entries(d.platforms).map(([name, info]) => {
      const icon = PLAT_ICONS[name] || 'ğŸ”—';
      const checked = info.configured ? 'checked' : '';
      const disabled = info.configured ? '' : 'disabled';
      if (info.configured) apSelectedPlatforms.push(name);
      return `<label class="flex items-center gap-2 text-sm ${!info.configured?'opacity-40':''}">
        <input type="checkbox" value="${name}" ${checked} ${disabled} onchange="apTogglePlatform('${name}', this.checked)">
        ${icon} ${name.replace('_',' ')} ${!info.configured?'<span class=\"text-xs text-red-400\">(not set)</span>':''}
      </label>`;
    }).join('');
  } catch(e) { console.error(e); }
}

function apTogglePlatform(name, checked) {
  if (checked && !apSelectedPlatforms.includes(name)) apSelectedPlatforms.push(name);
  if (!checked) apSelectedPlatforms = apSelectedPlatforms.filter(p => p !== name);
}

function apSelectAll() {
  document.querySelectorAll('#ap-platforms input[type=checkbox]:not(:disabled)').forEach(cb => { cb.checked = true; apTogglePlatform(cb.value, true); });
}

function apClearAll() {
  apSelectedPlatforms = [];
  document.querySelectorAll('#ap-platforms input[type=checkbox]').forEach(cb => cb.checked = false);
}

function apSetStep(n, status) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById(`ap-step-${['content','hashtags','schedule','save'][i-1]}`);
    if (!el) continue;
    const span = el.querySelector('span');
    if (i < n) { el.classList.remove('text-gray-400'); span.className = 'w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs'; span.textContent = 'âœ“'; }
    else if (i === n) { el.classList.remove('text-gray-400'); span.className = 'w-6 h-6 rounded-full bg-brand-500 text-white flex items-center justify-center text-xs animate-pulse'; span.textContent = i; }
    else { el.classList.add('text-gray-400'); span.className = 'w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs'; span.textContent = i; }
  }
}

async function runAutoPilot() {
  if (apSelectedPlatforms.length === 0) { toast('Select at least one platform', 'warning'); return; }

  const niche = document.getElementById('ap-niche').value;
  const topic = document.getElementById('ap-topic').value;
  const postsPerPlatform = parseInt(document.getElementById('ap-posts-per').value) || 1;
  const utcOffset = parseInt(document.getElementById('ap-utc').value) || 0;
  const autoHashtags = document.getElementById('ap-auto-hashtags').checked;
  const bestTimes = document.getElementById('ap-best-times').checked;

  document.getElementById('ap-empty').classList.add('hidden');
  document.getElementById('ap-result').classList.add('hidden');
  document.getElementById('ap-progress').classList.remove('hidden');

  try {
    // Step 1: Generate content
    apSetStep(1, 'active');
    const contentResp = await fetch('/api/autopilot/generate', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ niche, topic: topic || null, platforms: apSelectedPlatforms })
    }).then(r => r.json());

    if (contentResp.error) { toast(contentResp.error, 'error'); return; }

    // Step 2: Hashtags
    apSetStep(2, 'active');
    let hashtags = [];
    if (autoHashtags) {
      try {
        const hResp = await fetch('/api/hashtags/generate', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ niche, platform: 'instagram' })
        }).then(r => r.json());
        hashtags = hResp.hashtags?.combined || [];
      } catch(e) { hashtags = []; }
    }

    // Step 3: Schedule
    apSetStep(3, 'active');
    let schedule = [];
    if (bestTimes) {
      try {
        const sResp = await fetch('/api/time-slots/schedule', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ platforms: apSelectedPlatforms, posts_per_platform: postsPerPlatform, utc_offset: utcOffset, spacing_minutes: 30 })
        }).then(r => r.json());
        schedule = sResp.schedule || sResp || [];
      } catch(e) { schedule = []; }
    }

    // Step 4: Show results
    apSetStep(4, 'active');
    apGeneratedData = { ...contentResp, hashtags, schedule, platforms: apSelectedPlatforms, niche };

    // Render preview
    document.getElementById('ap-gen-title').textContent = contentResp.title || 'Auto-generated post';
    document.getElementById('ap-gen-body').textContent = contentResp.body || contentResp.content || '';
    document.getElementById('ap-gen-tags').innerHTML = hashtags.slice(0, 20).map(t => `<span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">${t}</span>`).join('');

    // Render schedule
    const schedList = document.getElementById('ap-schedule-list');
    if (schedule.length > 0) {
      schedList.innerHTML = schedule.map(s => `<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm">
        <span>${PLAT_ICONS[s.platform]||'ğŸ”—'} ${s.platform}</span>
        <span class="font-mono">${s.time || s.suggested_time || 'ASAP'}</span>
        <span class="text-xs text-gray-400">${s.source || 'static'}</span>
      </div>`).join('');
    } else {
      schedList.innerHTML = '<p class="text-sm text-gray-400">Publish immediately (no schedule)</p>';
    }

    apSetStep(5, 'done');
    document.getElementById('ap-result').classList.remove('hidden');
    document.getElementById('ap-progress').classList.add('hidden');
    toast('Auto-Pilot complete! Review and confirm.', 'success');

  } catch(e) {
    toast('Auto-Pilot error: ' + e.message, 'error');
    document.getElementById('ap-progress').classList.add('hidden');
    document.getElementById('ap-empty').classList.remove('hidden');
  }
}

async function apConfirmPublish() {
  if (!apGeneratedData) return;
  toast('Saving and scheduling posts...');
  try {
    const data = {
      title: apGeneratedData.title || 'Auto-Pilot Post',
      body: (apGeneratedData.body || apGeneratedData.content || '') + '\n\n' + (apGeneratedData.hashtags || []).join(' '),
      category: 'general',
      platforms: apGeneratedData.platforms,
      status: apGeneratedData.schedule?.length > 0 ? 'scheduled' : 'draft',
      scheduled_at: apGeneratedData.schedule?.[0]?.time || '',
      extra_fields: { hashtags: apGeneratedData.hashtags },
    };
    const r = await fetch('/api/posts', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}).then(r=>r.json());
    if (r.success) {
      if (data.status === 'draft') {
        // Publish immediately
        const pub = await fetch(`/api/publish/${r.post_id}`, {method:'POST'}).then(r=>r.json());
        pub.results?.forEach(res => toast(`${res.platform}: ${res.success?'âœ…':'âŒ '+res.error}`, res.success?'success':'error'));
      } else {
        toast('Post scheduled! Check Content Library.', 'success');
      }
    }
  } catch(e) { toast('Publish error', 'error'); }
}

function apEditAndPublish() {
  if (!apGeneratedData) return;
  // Navigate to compose page and pre-fill
  window.location.href = '/compose';
  setTimeout(() => {
    const titleEl = document.getElementById('post-title');
    const bodyEl = document.getElementById('post-body');
    if (titleEl) titleEl.value = apGeneratedData.title || '';
    if (bodyEl) bodyEl.value = (apGeneratedData.body || '') + '\n\n' + (apGeneratedData.hashtags || []).join(' ');
  }, 500);
}

function apRegenerate() {
  document.getElementById('ap-result').classList.add('hidden');
  document.getElementById('ap-empty').classList.remove('hidden');
  apGeneratedData = null;
  runAutoPilot();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLATFORMS PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PLAT_ICONS = {
  twitter:'ğŸ¦', instagram:'ğŸ“·', facebook:'ğŸ“˜', youtube:'â–¶ï¸', linkedin:'ğŸ’¼',
  tiktok:'ğŸµ', pinterest:'ğŸ“Œ', reddit:'ğŸ”´', medium:'âœï¸', tumblr:'ğŸ”µ',
  threads:'ğŸ§µ', bluesky:'ğŸ¦‹', mastodon:'ğŸ˜', quora:'â“', shopify_blog:'ğŸ›ï¸', lemon8:'ğŸ‹'
};
const DIFF_COLORS = { easy:'green', medium:'yellow', hard:'red' };

let allPlatforms = {};

async function loadPlatforms() {
  try {
    const r = await fetch('/api/platforms/setup-status');
    const d = await r.json();
    allPlatforms = d.platforms;
    document.getElementById('plat-total').textContent = d.total;
    document.getElementById('plat-configured').textContent = d.configured;
    document.getElementById('plat-missing').textContent = d.not_configured;
    renderPlatforms('all');
  } catch(e) { toast('Failed to load platforms', 'error'); }
}

function filterPlatforms(filter) {
  renderPlatforms(filter);
}

function renderPlatforms(filter) {
  const grid = document.getElementById('platforms-grid');
  let entries = Object.entries(allPlatforms);
  if (filter !== 'all') entries = entries.filter(([,v]) => v.difficulty === filter);

  grid.innerHTML = entries.map(([name, info]) => {
    const icon = PLAT_ICONS[name] || 'ğŸ”—';
    const dc = DIFF_COLORS[info.difficulty];
    const status = info.configured;
    return `<div class="bg-white rounded-xl p-4 shadow-sm border ${status ? 'border-green-200' : 'border-red-200'}">
      <div class="flex items-center justify-between mb-2">
        <span class="text-2xl">${icon}</span>
        <span class="text-xs px-2 py-0.5 rounded-full ${status ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${status ? 'âœ… Ready' : 'âŒ Not Set'}</span>
      </div>
      <h4 class="font-semibold text-gray-800 capitalize">${name.replace('_',' ')}</h4>
      <span class="inline-block mt-1 text-xs px-2 py-0.5 rounded-full bg-${dc}-100 text-${dc}-700">${info.difficulty}</span>
      <div class="mt-2 text-xs text-gray-500">
        ${info.env_keys_needed.map(k => `<span class="${info.configured ? 'text-green-600' : 'text-red-400'}">${k}</span>`).join('<br>')}
      </div>
      ${info.docs_url ? `<a href="${info.docs_url}" target="_blank" class="mt-2 inline-block text-xs text-brand-500 hover:underline">ğŸ“„ Setup docs â†’</a>` : ''}
    </div>`;
  }).join('');

  if (entries.length === 0) grid.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">No platforms match this filter</p>';
}

async function loadSidebarChannels() {
  try {
    const r = await fetch('/api/platforms/setup-status');
    const d = await r.json();
    const el = document.getElementById('sidebar-channels');
    if (!el) return;
    el.innerHTML = Object.entries(d.platforms).map(([name, info]) => {
      const icon = PLAT_ICONS[name] || 'ğŸ”—';
      const color = info.configured ? 'bg-green-500' : 'bg-gray-500';
      return `<div class="flex items-center gap-2 px-3 py-1 text-xs text-gray-400">
        <span class="w-2 h-2 rounded-full ${color}"></span> ${icon} ${name.replace('_',' ')}
      </div>`;
    }).join('');
  } catch(e) { /* sidebar is non-critical */ }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENGAGEMENT PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function fetchEngagement() {
  toast('Fetching engagement data...', 'info');
  try {
    await fetch('/api/engagement/fetch', { method:'POST', headers:{'Content-Type':'application/json'}, body:'{}' });
    toast('Engagement data updated!', 'success');
    loadEngagement();
  } catch(e) { toast('Fetch failed', 'error'); }
}

async function loadEngagement(platform) {
  try {
    let url = '/api/engagement/summary?days=30';
    if (platform) url += '&platform=' + platform;
    const r = await fetch(url);
    const d = await r.json();

    // Update stats
    const totals = d.totals || {};
    document.getElementById('eng-likes').textContent = (totals.likes || 0).toLocaleString();
    document.getElementById('eng-shares').textContent = (totals.shares || 0).toLocaleString();
    document.getElementById('eng-comments').textContent = (totals.comments || 0).toLocaleString();
    document.getElementById('eng-views').textContent = (totals.views || 0).toLocaleString();
    document.getElementById('eng-posts').textContent = (totals.posts_tracked || 0).toLocaleString();

    // Update table
    const table = document.getElementById('engagement-table');
    const platforms = d.by_platform || {};
    const rows = Object.entries(platforms);

    if (rows.length === 0) {
      table.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">No engagement data yet. Click "Fetch Latest" to pull metrics.</td></tr>';
      return;
    }

    table.innerHTML = rows.map(([name, m]) => {
      const icon = PLAT_ICONS[name] || 'ğŸ”—';
      return `<tr class="border-b hover:bg-gray-50">
        <td class="px-4 py-3 font-medium">${icon} ${name}</td>
        <td class="px-4 py-3 text-right text-pink-600">${(m.likes||0).toLocaleString()}</td>
        <td class="px-4 py-3 text-right text-blue-600">${(m.shares||0).toLocaleString()}</td>
        <td class="px-4 py-3 text-right text-green-600">${(m.comments||0).toLocaleString()}</td>
        <td class="px-4 py-3 text-right text-purple-600">${(m.views||0).toLocaleString()}</td>
        <td class="px-4 py-3 text-right text-gray-600">${(m.posts||0).toLocaleString()}</td>
      </tr>`;
    }).join('');
  } catch(e) { toast('Engagement load error', 'error'); }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIME SLOTS PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function suggestTime() {
  const platform = document.getElementById('ts-platform').value;
  try {
    const r = await fetch('/api/time-slots/suggest/' + platform + '?utc_offset=7');
    const d = await r.json();
    const resultEl = document.getElementById('ts-result');
    resultEl.classList.remove('hidden');
    const txt = d.suggested_time || d.next_time || JSON.stringify(d);
    document.getElementById('ts-result-text').textContent =
      `Next best time for ${platform}: ${txt}` + (d.source ? ` (${d.source})` : '');
  } catch(e) { toast('Suggest failed', 'error'); }
}

async function generateSchedule() {
  const postsPerPlatform = parseInt(document.getElementById('ts-posts-per').value) || 2;
  const utcOffset = parseInt(document.getElementById('ts-utc').value) || 0;
  try {
    const r = await fetch('/api/time-slots/schedule', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        platforms: ['twitter','instagram','tiktok','facebook','linkedin','reddit','bluesky','mastodon'],
        posts_per_platform: postsPerPlatform,
        utc_offset: utcOffset,
        spacing_minutes: 30,
      })
    });
    const d = await r.json();
    const schedule = d.schedule || d || [];
    const resultEl = document.getElementById('schedule-result');
    resultEl.classList.remove('hidden');
    const table = document.getElementById('schedule-table');

    if (Array.isArray(schedule) && schedule.length > 0) {
      table.innerHTML = schedule.map(s => `<tr class="border-b hover:bg-gray-50">
        <td class="px-4 py-2 font-mono text-sm">${s.time || s.suggested_time || '-'}</td>
        <td class="px-4 py-2">${PLAT_ICONS[s.platform]||'ğŸ”—'} ${s.platform || '-'}</td>
        <td class="px-4 py-2 text-xs text-gray-500">${s.source || 'static'}</td>
        <td class="px-4 py-2 text-right">${s.confidence ? (s.confidence * 100).toFixed(0)+'%' : '-'}</td>
      </tr>`).join('');
    } else {
      table.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">No schedule data</td></tr>';
    }
    toast('Schedule generated!', 'success');
  } catch(e) { toast('Schedule generation failed', 'error'); }
}

async function loadBestHours() {
  try {
    const r = await fetch('/api/time-slots/best-hours?days=30');
    const d = await r.json();
    const grid = document.getElementById('best-hours-grid');
    const hours = d.hours || d.best_hours || d.platforms || {};

    if (typeof hours === 'object' && !Array.isArray(hours)) {
      grid.innerHTML = Object.entries(hours).map(([plat, info]) => {
        const icon = PLAT_ICONS[plat] || 'ğŸ”—';
        const bestHour = Array.isArray(info) ? info[0] : (info.best_hour || info);
        return `<div class="bg-gray-50 rounded-lg p-3">
          <div class="flex items-center gap-2 mb-1">
            <span>${icon}</span>
            <span class="font-medium text-sm capitalize">${plat}</span>
          </div>
          <p class="text-lg font-bold text-brand-600">${typeof bestHour === 'object' ? (bestHour.hour || JSON.stringify(bestHour)) : bestHour}</p>
          <p class="text-xs text-gray-500">${info.source || 'static fallback'}</p>
        </div>`;
      }).join('');
    } else {
      grid.innerHTML = '<p class="text-gray-400 col-span-full text-center py-4">No analytics data yet â€” using static defaults</p>';
    }
  } catch(e) { /* non-critical */ }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE PREVIEW PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PLATFORM_LIMITS = {
  twitter: 280, instagram: 2200, linkedin: 3000,
  facebook: 63206, tiktok: 2200, reddit: 40000
};

function updatePreviews() {
  const title = document.getElementById('pv-title')?.value || '';
  const body = document.getElementById('pv-body')?.value || '';
  const tags = document.getElementById('pv-hashtags')?.value || '';
  const imageUrl = document.getElementById('pv-image')?.value || '';

  const fullText = body + (tags ? '\n\n' + tags : '');
  const twitterText = (title ? title + '\n\n' : '') + body;
  const twitterFull = twitterText + (tags ? '\n' + tags : '');

  // Character stats
  const statsEl = document.getElementById('pv-char-stats');
  if (statsEl) {
    statsEl.innerHTML = Object.entries(PLATFORM_LIMITS).map(([p, limit]) => {
      const len = p === 'reddit' ? (title.length + body.length) : (p === 'twitter' ? twitterFull.length : fullText.length);
      const pct = Math.round(len / limit * 100);
      const color = pct > 100 ? 'text-red-600 font-bold' : pct > 80 ? 'text-amber-600' : 'text-green-600';
      return `<p class="${color}">${PLAT_ICONS[p]} ${p}: ${len}/${limit} (${pct}%)</p>`;
    }).join('');
  }

  // Helper: set image
  function setImage(prefix) {
    const container = document.getElementById(`pv-${prefix}-img`);
    if (!container) return;
    const img = container.querySelector('img');
    if (imageUrl) { img.src = imageUrl; container.classList.remove('hidden'); }
    else { container.classList.add('hidden'); }
  }

  // Helper: limit badge
  function setLimit(id, len, max) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = `${len} / ${max}`;
    el.className = `text-xs px-2 py-0.5 rounded-full ${len > max ? 'bg-red-100 text-red-700' : len > max * 0.8 ? 'bg-amber-100 text-amber-700' : 'bg-green-100 text-green-700'}`;
  }

  // Twitter
  const twText = twitterFull.length > 280 ? twitterFull.slice(0, 277) + '...' : twitterFull;
  const twEl = document.getElementById('pv-tw-text');
  if (twEl) twEl.textContent = twText;
  setLimit('pv-tw-limit', twitterFull.length, 280);
  const twTags = document.getElementById('pv-tw-tags');
  if (twTags) twTags.textContent = twitterFull.length > 280 ? 'âš ï¸ Over limit! Will be truncated.' : '';
  setImage('tw');

  // Instagram
  const igEl = document.getElementById('pv-ig-caption');
  if (igEl) igEl.textContent = body;
  const igTags = document.getElementById('pv-ig-tags');
  if (igTags) igTags.textContent = tags;
  setLimit('pv-ig-limit', fullText.length, 2200);
  setImage('ig');

  // LinkedIn
  const liEl = document.getElementById('pv-li-text');
  if (liEl) liEl.textContent = (title ? '**' + title + '**\n\n' : '') + body;
  const liTags = document.getElementById('pv-li-tags');
  if (liTags) liTags.textContent = tags;
  setLimit('pv-li-limit', fullText.length, 3000);
  setImage('li');

  // Facebook
  const fbEl = document.getElementById('pv-fb-text');
  if (fbEl) fbEl.textContent = (title ? title + '\n\n' : '') + body;
  const fbTags = document.getElementById('pv-fb-tags');
  if (fbTags) fbTags.textContent = tags;
  setLimit('pv-fb-limit', fullText.length, 63206);
  setImage('fb');

  // TikTok
  const ttEl = document.getElementById('pv-tt-text');
  if (ttEl) ttEl.textContent = body.length > 150 ? body.slice(0, 147) + '...' : body;
  const ttTags = document.getElementById('pv-tt-tags');
  if (ttTags) ttTags.innerHTML = tags.split(/\s+/).filter(t => t.startsWith('#')).map(t => `<span class="text-blue-400">${t}</span>`).join(' ');
  setLimit('pv-tt-limit', fullText.length, 2200);

  // Reddit
  const rdTitle = document.getElementById('pv-rd-title');
  if (rdTitle) rdTitle.textContent = title || '(Untitled post)';
  const rdText = document.getElementById('pv-rd-text');
  if (rdText) rdText.textContent = body;
  setLimit('pv-rd-limit', (title + body).length, 40000);
  setImage('rd');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYTICS CHARTS (Chart.js)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let chartTrend = null;
let chartPlatforms = null;
let chartHours = null;
let analyticsPeriod = 30;

function setAnalyticsPeriod(days) {
  analyticsPeriod = days;
  document.querySelectorAll('[id^="ap-"]').forEach(btn => {
    btn.className = 'px-3 py-1.5 text-xs rounded-full ' +
      (btn.id === 'ap-' + days ? 'bg-brand-500 text-white' : 'bg-gray-200 hover:bg-brand-100');
  });
  loadAnalytics();
}

function buildTrendChart(logs) {
  const ctx = document.getElementById('chart-trend');
  if (!ctx) return;

  // Group by date
  const byDate = {};
  logs.forEach(l => {
    const d = (l.published_at || '').slice(0, 10);
    if (!d) return;
    if (!byDate[d]) byDate[d] = { success: 0, failed: 0 };
    l.success ? byDate[d].success++ : byDate[d].failed++;
  });

  const dates = Object.keys(byDate).sort().slice(-analyticsPeriod);
  const successData = dates.map(d => byDate[d].success);
  const failedData = dates.map(d => byDate[d].failed);

  if (chartTrend) chartTrend.destroy();
  chartTrend = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates.map(d => d.slice(5)),
      datasets: [
        { label: 'Success', data: successData, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.3 },
        { label: 'Failed', data: failedData, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true, tension: 0.3 }
      ]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
  });
}

function buildPlatformChart(stats) {
  const ctx = document.getElementById('chart-platforms');
  if (!ctx) return;

  const names = Object.keys(stats);
  const colors = ['#f97316','#22c55e','#3b82f6','#10b981','#6366f1','#ec4899','#14b8a6','#8b5cf6','#f59e0b','#06b6d4','#ef4444','#84cc16','#d946ef','#0ea5e9','#a855f7','#f43f5e'];
  const successData = names.map(n => stats[n].success || 0);
  const failedData = names.map(n => (stats[n].total || 0) - (stats[n].success || 0));

  if (chartPlatforms) chartPlatforms.destroy();
  chartPlatforms = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: names,
      datasets: [
        { label: 'Success', data: successData, backgroundColor: '#22c55e' },
        { label: 'Failed', data: failedData, backgroundColor: '#ef4444' }
      ]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } } } }
  });
}

function buildHoursChart(logs) {
  const ctx = document.getElementById('chart-hours');
  if (!ctx) return;

  const hours = new Array(24).fill(0);
  logs.forEach(l => {
    const h = parseInt((l.published_at || '').slice(11, 13));
    if (!isNaN(h)) hours[h]++;
  });

  if (chartHours) chartHours.destroy();
  chartHours = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: hours.map((_, i) => `${String(i).padStart(2, '0')}:00`),
      datasets: [{ label: 'Posts', data: hours, backgroundColor: '#818cf8', borderRadius: 4 }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
  });
}

function renderTopPosts(logs) {
  const el = document.getElementById('top-posts');
  if (!el) return;
  const successful = logs.filter(l => l.success && l.post_url);
  if (successful.length === 0) { el.innerHTML = '<p class="text-gray-400 text-sm">No successful posts with URLs yet</p>'; return; }
  el.innerHTML = successful.slice(0, 10).map((l, i) => {
    const icon = PLAT_ICONS[l.platform] || 'ğŸ”—';
    return `<div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg">
      <span class="text-lg font-bold text-gray-300 w-6">${i + 1}</span>
      <span class="text-lg">${icon}</span>
      <div class="flex-1 min-w-0">
        <p class="text-sm font-medium truncate">${l.title || l.platform}</p>
        <p class="text-xs text-gray-400">${(l.published_at || '').slice(0, 16)}</p>
      </div>
      <a href="${l.post_url}" target="_blank" class="text-xs text-brand-500 hover:underline whitespace-nowrap">View â†’</a>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Publer Bridge Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadPublerStatus() {
  try {
    const resp = await fetch('/api/publer/status');
    const data = await resp.json();
    const badge = document.getElementById('snd-status-badge');
    const info = document.getElementById('snd-status-info');
    const authMode = document.getElementById('snd-auth-mode');

    if (data.configured) {
      badge.textContent = 'Configured';
      badge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-900 text-green-300';
      info.innerHTML = '<p class="text-green-400">âœ… Publer API credentials detected</p>';
    } else {
      badge.textContent = 'Not Configured';
      badge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-red-900 text-red-300';
      info.innerHTML = '<p class="text-red-400">âŒ Set PUBLER_API_KEY and PUBLER_WORKSPACE_ID in .env</p>';
    }

    authMode.innerHTML = `
      <p class="text-lg font-bold mb-2">${data.api_key_set ? 'ğŸ”‘ API Key Set' : 'âŒ API Key Missing'}</p>
      <div class="space-y-1 mt-3">
        <div class="flex items-center gap-2">
          <span class="${data.api_key_set ? 'text-green-400' : 'text-red-400'}">${data.api_key_set ? 'âœ…' : 'âŒ'}</span>
          <span class="text-xs font-mono">PUBLER_API_KEY ${data.api_key_preview || ''}</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="${data.workspace_id_set ? 'text-green-400' : 'text-red-400'}">${data.workspace_id_set ? 'âœ…' : 'âŒ'}</span>
          <span class="text-xs font-mono">PUBLER_WORKSPACE_ID</span>
        </div>
      </div>`;
  } catch (e) {
    console.error('Publer status error:', e);
  }
}

async function testPublerConnection() {
  const badge = document.getElementById('snd-status-badge');
  const info = document.getElementById('snd-status-info');
  badge.textContent = 'Testing...';
  badge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-yellow-900 text-yellow-300';
  info.innerHTML = '<p class="text-yellow-400">â³ Testing Publer connection...</p>';

  try {
    const resp = await fetch('/api/publer/test', { method: 'POST' });
    const data = await resp.json();

    if (data.connected) {
      badge.textContent = 'Connected';
      badge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-900 text-green-300';
      info.innerHTML = `
        <p class="text-green-400">âœ… Connected as <strong>${data.account || 'N/A'}</strong></p>
        <p class="text-sm mt-1">${data.accounts_count || 0} accounts available</p>`;

      // Also refresh accounts
      refreshPublerAccounts();
      loadPublerWorkspaceInfo();
    } else {
      badge.textContent = 'Failed';
      badge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-red-900 text-red-300';
      info.innerHTML = `<p class="text-red-400">âŒ ${data.error || 'Connection failed'}</p>`;
    }
  } catch (e) {
    badge.textContent = 'Error';
    badge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-red-900 text-red-300';
    info.innerHTML = `<p class="text-red-400">âŒ ${e.message}</p>`;
  }
}

async function refreshPublerAccounts() {
  const grid = document.getElementById('snd-services-grid');
  grid.innerHTML = '<p class="text-yellow-400 text-sm col-span-4">Loading accounts...</p>';

  try {
    const resp = await fetch('/api/publer/accounts');
    const data = await resp.json();

    if (data.accounts && data.accounts.length > 0) {
      const icons = {
        instagram: 'ğŸ“¸', tiktok: 'ğŸµ', facebook: 'ğŸ“˜', twitter: 'ğŸ¦',
        linkedin: 'ğŸ’¼', youtube: 'ğŸ“º', pinterest: 'ğŸ“Œ', tumblr: 'ğŸ”®',
        wordpress: 'ğŸ“', medium: 'âœï¸', google: 'ğŸ”', default: 'ğŸŒ'
      };
      grid.innerHTML = data.accounts.map(a => {
        const name = (a.name || a.type || 'Unknown').toLowerCase();
        const icon = Object.entries(icons).find(([k]) => name.includes(k))?.[1] || icons.default;
        return `<div class="bg-dark-800 border border-dark-600 rounded-lg p-3 flex items-center gap-3">
          <span class="text-xl">${icon}</span>
          <div>
            <p class="text-sm font-medium text-white">${a.name || a.type || 'Unknown'}</p>
            <p class="text-xs text-gray-500">ID: ${a.id || '?'}</p>
          </div>
        </div>`;
      }).join('');
    } else {
      grid.innerHTML = `<p class="text-gray-500 text-sm col-span-4">${data.error || 'No accounts found. Connect platforms in Publer first.'}</p>`;
    }
  } catch (e) {
    grid.innerHTML = `<p class="text-red-400 text-sm col-span-4">Error: ${e.message}</p>`;
  }
}

async function loadPublerWorkspaceInfo() {
  try {
    const resp = await fetch('/api/publer/workspaces');
    const data = await resp.json();
    const el = document.getElementById('snd-account-info');
    if (data.error) {
      el.innerHTML = `<p class="text-red-400">${data.error}</p>`;
    } else {
      const ws = data.workspaces || [];
      el.innerHTML = ws.length > 0
        ? ws.map(w => `<p class="text-sm text-gray-300">ğŸ“ ${w.name || w.id}</p>`).join('')
        : `<pre class="text-xs text-gray-400 overflow-auto max-h-32">${JSON.stringify(data, null, 2)}</pre>`;
    }
  } catch (e) {
    console.error('Publer workspace error:', e);
  }
}

async function publerPublish(isSchedule) {
  const message = document.getElementById('snd-message').value.trim();
  const platforms = document.getElementById('snd-platforms').value.trim();
  const schedule = document.getElementById('snd-schedule').value;
  const media = document.getElementById('snd-media').value.trim();
  const hashtags = document.getElementById('snd-hashtags').value.trim();
  const resultEl = document.getElementById('snd-publish-result');

  if (!message) { alert('Message is required'); return; }
  if (isSchedule && !schedule) { alert('Schedule date is required for scheduling'); return; }

  resultEl.className = 'mt-4 p-4 rounded-lg text-sm bg-yellow-900/30 text-yellow-300';
  resultEl.textContent = 'â³ Publishing via Publer...';
  resultEl.classList.remove('hidden');

  const body = { caption: message };
  if (platforms) body.platforms = platforms.split(',').map(p => p.trim());
  if (isSchedule && schedule) body.schedule_at = schedule;
  if (media) body.media_url = media;
  if (hashtags) body.hashtags = hashtags.split(',').map(h => h.trim());

  try {
    const resp = await fetch('/api/publer/publish', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await resp.json();

    if (data.success) {
      resultEl.className = 'mt-4 p-4 rounded-lg text-sm bg-green-900/30 text-green-300';
      resultEl.innerHTML = `âœ… ${data.scheduled ? 'Scheduled' : 'Published'} successfully (Job: ${data.job_id || 'N/A'})`;
      document.getElementById('snd-message').value = '';
    } else {
      resultEl.className = 'mt-4 p-4 rounded-lg text-sm bg-red-900/30 text-red-300';
      resultEl.textContent = `âŒ ${data.error || 'Publish failed'}`;
    }
  } catch (e) {
    resultEl.className = 'mt-4 p-4 rounded-lg text-sm bg-red-900/30 text-red-300';
    resultEl.textContent = `âŒ ${e.message}`;
  }
}

async function loadPublerWorkspaces() {
  const el = document.getElementById('snd-messages-list');
  el.innerHTML = '<p class="text-yellow-400 text-sm">Loading workspaces...</p>';

  try {
    const resp = await fetch('/api/publer/workspaces');
    const data = await resp.json();

    if (data.workspaces && data.workspaces.length > 0) {
      el.innerHTML = data.workspaces.map(w => {
        return `<div class="bg-dark-800 border border-dark-600 rounded-lg p-3">
          <div class="flex items-center gap-2 mb-1">
            <span>ğŸ“</span>
            <span class="text-sm font-medium text-white">${w.name || 'Workspace'}</span>
          </div>
          <p class="text-xs text-gray-500">ID: ${w.id || '?'}</p>
        </div>`;
      }).join('');
    } else {
      el.innerHTML = `<p class="text-gray-500 text-sm">${data.error || 'No workspaces found'}</p>`;
    }
  } catch (e) {
    el.innerHTML = `<p class="text-red-400 text-sm">Error: ${e.message}</p>`;
  }
}

// â”€â”€ Blog Auto-Share â”€â”€
async function loadBlogShareStatus() {
  try {
    const [status, config, history] = await Promise.all([
      fetch('/api/blog-share/status').then(r=>r.json()),
      fetch('/api/blog-share/config').then(r=>r.json()),
      fetch('/api/blog-share/history?limit=30').then(r=>r.json()),
    ]);

    // Status cards
    const paused = config.paused || status.paused;
    document.getElementById('bs-status').innerHTML = paused
      ? '<span class="text-amber-500">â¸ï¸ Paused</span>'
      : '<span class="text-green-500">â–¶ï¸ Active</span>';
    document.getElementById('bs-total-shared').textContent = (history.history || []).length;
    document.getElementById('bs-tiktok-via').textContent = (config.tiktok_via || 'publer').toUpperCase();
    document.getElementById('bs-pinterest-via').textContent = (config.pinterest_via || 'publer').toUpperCase();

    // Config inputs
    if(config.interval_min) document.getElementById('bs-interval').value = config.interval_min;
    if(config.max_per_cycle) document.getElementById('bs-max-per-cycle').value = config.max_per_cycle;
    if(config.tiktok_mode) document.getElementById('bs-tiktok-mode').value = config.tiktok_mode;

    // History
    const histEl = document.getElementById('bs-history');
    const items = history.history || [];
    if(items.length === 0) {
      histEl.innerHTML = '<p class="text-gray-500 text-sm">No articles shared yet.</p>';
    } else {
      histEl.innerHTML = items.map(h => {
        const tkOk = (h.tiktok||[]).filter(t=>t.success).length;
        const tkTotal = (h.tiktok||[]).length;
        const pinOk = h.pinterest?.success ? 'âœ…' : (h.pinterest ? 'âŒ' : 'â€”');
        const via = h.tiktok?.[0]?.account === 'publer' ? 'ğŸ”—Publer' : 'ğŸ”ŒAPI';
        return `<div class="flex justify-between items-center p-3 bg-dark-800 rounded-lg border border-dark-600">
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-white truncate">${h.title||'Untitled'}</p>
            <p class="text-xs text-gray-400">${h.blog||''} Â· ${h.shared_at||''}</p>
          </div>
          <div class="flex gap-3 text-xs ml-4 flex-shrink-0">
            <span class="px-2 py-1 rounded-full bg-pink-900/30 text-pink-300">TikTok ${tkOk}/${tkTotal}</span>
            <span class="px-2 py-1 rounded-full bg-red-900/30 text-red-300">Pin ${pinOk}</span>
            <span class="px-2 py-1 rounded-full bg-dark-600 text-gray-300">${via}</span>
          </div>
        </div>`;
      }).join('');
    }
  } catch(e) {
    document.getElementById('bs-status').innerHTML = '<span class="text-red-400">Error</span>';
    console.error('Blog share load error:', e);
  }
}

async function bsSaveConfig() {
  const body = {
    interval_min: parseInt(document.getElementById('bs-interval').value) || 30,
    max_per_cycle: parseInt(document.getElementById('bs-max-per-cycle').value) || 5,
    tiktok_mode: document.getElementById('bs-tiktok-mode').value,
  };
  await fetch('/api/blog-share/config', {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
  showToast('Config saved âœ…');
  loadBlogShareStatus();
}

async function bsPause() {
  await fetch('/api/blog-share/pause', {method:'POST'});
  showToast('Auto-share paused â¸ï¸');
  loadBlogShareStatus();
}

async function bsResume() {
  await fetch('/api/blog-share/resume', {method:'POST'});
  showToast('Auto-share resumed â–¶ï¸');
  loadBlogShareStatus();
}

async function bsTick() {
  showToast('Running tick... ğŸ”„');
  const r = await fetch('/api/blog-share/tick', {method:'POST'}).then(r=>r.json());
  showToast(`Tick done â€” shared ${r.shared||0} articles`);
  loadBlogShareStatus();
}

async function bsManualShare() {
  const url = document.getElementById('bs-manual-url').value.trim();
  if(!url) { showToast('Enter article URL first', 'error'); return; }
  showToast('Sharing... ğŸš€');
  const r = await fetch('/api/blog-share/manual', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url, force:false})}).then(r=>r.json());
  showToast(r.error ? `Error: ${r.error}` : 'Shared successfully âœ…');
  loadBlogShareStatus();
}

async function bsShareLatest() {
  const blog = document.getElementById('bs-latest-blog').value;
  showToast(`Sharing latest from ${blog}... ğŸ“¤`);
  const r = await fetch('/api/blog-share/latest', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({blog_handle:blog, count:1, force:false})}).then(r=>r.json());
  showToast(r.error ? `Error: ${r.error}` : 'Shared latest âœ…');
  loadBlogShareStatus();
}

async function bsClearHistory() {
  if(!confirm('Clear all share history? This allows all articles to be re-shared.')) return;
  await fetch('/api/blog-share/history', {method:'DELETE'});
  showToast('History cleared ğŸ—‘ï¸');
  loadBlogShareStatus();
}
</script>
</body>
</html>
